<!DOCTYPE html>
<html lang="es">
<head>
   <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Proyectos de Investigación - IESTP Huancayo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- ✅ NUEVA LÍNEA -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURACIÓN DE SUPABASE (MANUAL)
        // ============================================
        const SUPABASE_URL = 'https://jhubijlwspqjfczngvnr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodWJpamx3c3BxamZjem5ndm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTMzMjUsImV4cCI6MjA3ODY2OTMyNX0.bhkI-cQsnQ55CTgRiOuMm4pi1lAnwwgPlZAqqXkUGkI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // ESTADO GLOBAL DE LA APLICACIÓN
        // ============================================
        let state = {
            currentUser: null,
            view: 'login',
            projects: [],
            users: [],
            selectedProject: null,
            notifications: [],
            showModal: false,
            modalContent: null
        };
// ============================================
        // GENERADOR DE CRONOGRAMA
        // ============================================
        function generarCronograma(fechaInicio, fechaFin) {
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            
            // Calcular duración total en días
            const duracionTotal = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
            
            // Calcular intervalo entre entregas (6 avances)
            const intervalo = Math.floor(duracionTotal / 6);
            
            const entregas = [
                '1er avance',
                '2do avance',
                '3er avance',
                '4to avance',
                '5to avance',
                '6to avance'
            ];
            
            const cronograma = [];
            
            for (let i = 0; i < entregas.length; i++) {
                const fecha = new Date(inicio);
                fecha.setDate(fecha.getDate() + (intervalo * (i + 1)));
                
                cronograma.push({
                    entrega: entregas[i],
                    fecha: fecha.toISOString().split('T')[0]
                });
            }
            
            return cronograma;
        }
        
        // Función para verificar si todos los avances están aprobados
        // Función para verificar si todos los avances están aprobados
async function verificarAvancesAprobados(projectId) {
    try {
        const { data, error } = await supabase
            .from('avances')
            .select('*')
            .eq('project_id', projectId)
            .in('numero_avance', [1, 2, 3, 4, 5, 6]);
        
        if (error) throw error;
        
        // Verificar que existan los 6 avances
        if (!data || data.length < 6) return false;
        
        // Verificar que todos estén aprobados
        return data.every(avance => avance.status === 'aprobado');
    } catch (error) {
        console.error('Error al verificar avances:', error);
        return false;
    }
}

// ============================================
// SISTEMA DE EVALUACIÓN PRE-INFORME FINAL
// ============================================

// Preguntas de evaluación final
const preguntasEvaluacionFinal = [
    { id: 1, pregunta: "¿El proyecto cumple con los objetivos planteados inicialmente?" },
    { id: 2, pregunta: "¿La metodología aplicada es coherente con el tipo de investigación?" },
    { id: 3, pregunta: "¿Los avances entregados demuestran progreso consistente?" },
    { id: 4, pregunta: "¿La documentación presentada es completa y clara?" },
    { id: 5, pregunta: "¿Se evidencia innovación o aporte significativo en el proyecto?" },
    { id: 6, pregunta: "¿Los resultados parciales son satisfactorios?" },
    { id: 7, pregunta: "¿El proyecto se ejecutó dentro de los plazos establecidos?" },
    { id: 8, pregunta: "¿Los recursos utilizados fueron empleados adecuadamente?" },
    { id: 9, pregunta: "¿El docente respondió adecuadamente a las observaciones previas?" },
    { id: 10, pregunta: "¿El proyecto tiene potencial para generar un informe final de calidad?" }
];

// Verificar si existe evaluación final
async function verificarEvaluacionFinal(projectId) {
    try {
        const { data, error } = await supabase
            .from('evaluaciones_finales')
            .select('*')
            .eq('project_id', projectId)
            .single();
        
        if (error && error.code !== 'PGRST116') throw error;
        return data;
    } catch (error) {
        console.error('Error al verificar evaluación:', error);
        return null;
    }
}

// Generar PDF de evaluación
async function generarPDFEvaluacion(evaluacion, project) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configuración
    const margen = 20;
    let y = margen;
    
    // Encabezado
    doc.setFontSize(18);
    doc.setTextColor(37, 99, 235); // Azul
    doc.text('EVALUACION PRE-INFORME FINAL', margen, y);
    y += 10;
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text('Instituto de Educacion Superior Tecnologico Publico Huancayo', margen, y);
    y += 15;
    
    // Línea separadora
    doc.setDrawColor(200, 200, 200);
    doc.line(margen, y, 190, y);
    y += 10;
    
    // Información del proyecto
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('INFORMACION DEL PROYECTO', margen, y);
    y += 7;
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(10);
    const tituloLineas = doc.splitTextToSize(`Titulo: ${project.title}`, 170);
    doc.text(tituloLineas, margen, y);
    y += (tituloLineas.length * 5) + 3;
    
    doc.text(`Docente: ${project.users?.name || 'N/A'}`, margen, y);
    y += 6;
    doc.text(`Tipo: ${project.type === 'investigacion_aplicada' ? 'Investigacion Aplicada' : 
                          project.type === 'innovacion_tecnologica' ? 'Innovacion Tecnologica' : 
                          'Innovacion Pedagogica'}`, margen, y);
    y += 6;
    doc.text(`Fecha de evaluacion: ${new Date(evaluacion.created_at).toLocaleDateString('es-ES', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    })}`, margen, y);
    y += 6;
    doc.text(`Evaluador: ${state.currentUser.name}`, margen, y);
    y += 12;
    
    // Línea separadora
    doc.line(margen, y, 190, y);
    y += 10;
    
    // Resultados
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('RESULTADOS DE LA EVALUACION', margen, y);
    y += 10;
    
    // Preguntas y respuestas
    doc.setFontSize(9);
    const respuestas = JSON.parse(evaluacion.respuestas);
    
    preguntasEvaluacionFinal.forEach((pregunta, index) => {
        if (y > 270) { // Nueva página si es necesario
            doc.addPage();
            y = margen;
        }
        
        doc.setFont(undefined, 'bold');
        const preguntaLineas = doc.splitTextToSize(`${index + 1}. ${pregunta.pregunta}`, 170);
        doc.text(preguntaLineas, margen, y);
        y += (preguntaLineas.length * 5) + 2;
        
        const respuesta = respuestas[pregunta.id];
        doc.setFont(undefined, 'normal');
        if (respuesta) {
            doc.setTextColor(34, 197, 94); // Verde
            doc.text('SI', margen + 5, y);
        } else {
            doc.setTextColor(239, 68, 68); // Rojo
            doc.text('NO', margen + 5, y);
        }
        doc.setTextColor(0, 0, 0);
        y += 8;
    });
    
    y += 5;
    
    // Línea separadora
    if (y > 250) {
        doc.addPage();
        y = margen;
    }
    doc.line(margen, y, 190, y);
    y += 10;
    
    // Resultado final
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RESULTADO FINAL', margen, y);
    y += 10;
    
    doc.setFontSize(11);
    doc.text(`Porcentaje de cumplimiento: ${evaluacion.porcentaje}%`, margen, y);
    y += 8;
    
    // Resultado con color
    if (evaluacion.aprobado) {
        doc.setTextColor(34, 197, 94);
        doc.text('APROBADO - Habilitado para presentar Informe Final', margen, y);
    } else {
        doc.setTextColor(239, 68, 68);
        doc.text('NO APROBADO - No cumple requisitos minimos (70%)', margen, y);
    }
    doc.setTextColor(0, 0, 0);
    y += 12;
    
    // Observaciones
    if (evaluacion.observaciones) {
        if (y > 250) {
            doc.addPage();
            y = margen;
        }
        doc.setFont(undefined, 'bold');
        doc.text('OBSERVACIONES:', margen, y);
        y += 7;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        const observacionesLineas = doc.splitTextToSize(evaluacion.observaciones, 170);
        doc.text(observacionesLineas, margen, y);
        y += (observacionesLineas.length * 5) + 10;
    }
    
    // Firmas
    if (y > 240) {
        doc.addPage();
        y = margen;
    }
    y = 250;
    doc.setFontSize(10);
    doc.line(margen + 20, y, margen + 80, y);
    doc.text('Jefe de Investigacion', margen + 30, y + 5);
    doc.text(state.currentUser.name, margen + 25, y + 10);
    
    // Guardar PDF
    const nombreArchivo = `Evaluacion_Final_${project.title.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    // También retornar el blob para guardarlo en Supabase
    return doc.output('blob');
}

// Abrir modal de evaluación final
async function openEvaluacionFinalModal(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    // Verificar si ya existe una evaluación
    const evaluacionExistente = await verificarEvaluacionFinal(projectId);
    
    if (evaluacionExistente) {
        // Mostrar evaluación existente
        mostrarEvaluacionExistente(evaluacionExistente, project);
        return;
    }

    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="closeModal(event)">
            <div class="bg-white rounded-lg w-full max-w-4xl my-8" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">
                                <i class="fas fa-clipboard-check mr-2"></i>
                                Evaluación Pre-Informe Final
                            </h3>
                            <p class="text-purple-100">${project.title}</p>
                            <p class="text-sm text-purple-200 mt-1">
                                <i class="fas fa-user mr-1"></i>${project.users?.name || 'Sin asignar'}
                            </p>
                        </div>
                        <button onclick="closeModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 text-xl mr-3 mt-1"></i>
                            <div>
                                <p class="text-sm text-blue-800 font-semibold mb-1">Instrucciones:</p>
                                <p class="text-sm text-blue-700">
                                    Responda SÍ o NO a cada pregunta. Se requiere un mínimo de <strong>70% de respuestas positivas</strong> 
                                    para aprobar y habilitar al docente para presentar el Informe Final.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form id="evaluacionFinalForm" class="space-y-4">
                        <div class="space-y-3">
                            ${preguntasEvaluacionFinal.map((pregunta, index) => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-start gap-4">
                                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-700 font-bold flex-shrink-0">
                                            ${index + 1}
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-gray-800 mb-3">${pregunta.pregunta}</p>
                                            <div class="flex gap-4">
                                                <label class="flex items-center cursor-pointer group">
                                                    <input 
                                                        type="radio" 
                                                        name="pregunta_${pregunta.id}" 
                                                        value="si" 
                                                        class="hidden peer"
                                                        required
                                                    >
                                                    <div class="w-20 h-10 flex items-center justify-center border-2 border-gray-300 rounded-lg 
                                                                peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700
                                                                group-hover:border-green-400 transition-all">
                                                        <i class="fas fa-check mr-1"></i>
                                                        <span class="font-semibold">SÍ</span>
                                                    </div>
                                                </label>
                                                <label class="flex items-center cursor-pointer group">
                                                    <input 
                                                        type="radio" 
                                                        name="pregunta_${pregunta.id}" 
                                                        value="no" 
                                                        class="hidden peer"
                                                        required
                                                    >
                                                    <div class="w-20 h-10 flex items-center justify-center border-2 border-gray-300 rounded-lg 
                                                                peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700
                                                                group-hover:border-red-400 transition-all">
                                                        <i class="fas fa-times mr-1"></i>
                                                        <span class="font-semibold">NO</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Observaciones adicionales (opcional)
                            </label>
                            <textarea 
                                id="evaluacionObservaciones"
                                rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                placeholder="Comentarios, recomendaciones o justificación de la evaluación..."
                            ></textarea>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mt-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Porcentaje de aprobación:</p>
                                    <p class="text-3xl font-bold text-purple-600" id="porcentajePreview">0%</p>
                                </div>
                                <div id="resultadoPreview" class="text-right">
                                    <p class="text-sm text-gray-600">Resultado:</p>
                                    <p class="text-lg font-semibold text-gray-400">Sin calcular</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button 
                                type="button" 
                                onclick="closeModal()" 
                                class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                            >
                                <i class="fas fa-check-double mr-2"></i>
                                Finalizar Evaluación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    render();

    // Event listeners
    setTimeout(() => {
        const form = document.getElementById('evaluacionFinalForm');
        const porcentajePreview = document.getElementById('porcentajePreview');
        const resultadoPreview = document.getElementById('resultadoPreview');

        // Calcular porcentaje en tiempo real
        form.addEventListener('change', () => {
            let respuestasPositivas = 0;
            let totalRespuestas = 0;

            preguntasEvaluacionFinal.forEach(pregunta => {
                const respuesta = form.querySelector(`input[name="pregunta_${pregunta.id}"]:checked`);
                if (respuesta) {
                    totalRespuestas++;
                    if (respuesta.value === 'si') {
                        respuestasPositivas++;
                    }
                }
            });

            if (totalRespuestas > 0) {
                const porcentaje = Math.round((respuestasPositivas / preguntasEvaluacionFinal.length) * 100);
                porcentajePreview.textContent = porcentaje + '%';

                if (porcentaje >= 70) {
                    resultadoPreview.innerHTML = `
                        <p class="text-sm text-gray-600">Resultado:</p>
                        <p class="text-lg font-semibold text-green-600">
                            <i class="fas fa-check-circle mr-1"></i>APROBADO
                        </p>
                    `;
                } else {
                    resultadoPreview.innerHTML = `
                        <p class="text-sm text-gray-600">Resultado:</p>
                        <p class="text-lg font-semibold text-red-600">
                            <i class="fas fa-times-circle mr-1"></i>NO APROBADO
                        </p>
                    `;
                }
            }
        });

        // Submit form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Recolectar respuestas
            const respuestas = {};
            let respuestasPositivas = 0;

            preguntasEvaluacionFinal.forEach(pregunta => {
                const respuesta = form.querySelector(`input[name="pregunta_${pregunta.id}"]:checked`);
                if (respuesta) {
                    const esSi = respuesta.value === 'si';
                    respuestas[pregunta.id] = esSi;
                    if (esSi) respuestasPositivas++;
                }
            });

            const porcentaje = Math.round((respuestasPositivas / preguntasEvaluacionFinal.length) * 100);
            const aprobado = porcentaje >= 70;
            const observaciones = document.getElementById('evaluacionObservaciones').value;

            // Guardar evaluación
            try {
                showNotification('Guardando evaluación...', 'info');

                const { data: evaluacionData, error } = await supabase
                    .from('evaluaciones_finales')
                    .insert([{
                        project_id: projectId,
                        evaluador_id: state.currentUser.id,
                        respuestas: JSON.stringify(respuestas),
                        porcentaje: porcentaje,
                        aprobado: aprobado,
                        observaciones: observaciones
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Generar PDF
                showNotification('Generando PDF...', 'info');
                const pdfBlob = await generarPDFEvaluacion(evaluacionData, project);

                // Subir PDF a Supabase Storage
                const nombreArchivoPDF = `evaluacion_final_${projectId}_${Date.now()}.pdf`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('project-files')
                    .upload(`evaluaciones/${nombreArchivoPDF}`, pdfBlob);

                if (uploadError) throw uploadError;

                // Obtener URL pública del PDF
                const { data: urlData } = supabase.storage
                    .from('project-files')
                    .getPublicUrl(`evaluaciones/${nombreArchivoPDF}`);

                // Actualizar evaluación con URL del PDF
                await supabase
                    .from('evaluaciones_finales')
                    .update({ pdf_url: urlData.publicUrl })
                    .eq('id', evaluacionData.id);

                showNotification(
                    aprobado ? 
                    'Evaluación completada. Proyecto APROBADO para informe final' : 
                    'Evaluación completada. Proyecto NO APROBADO',
                    aprobado ? 'success' : 'error'
                );

                closeModal();
                
                // Recargar proyectos
                state.projects = await getProjects();
                render();

            } catch (error) {
                console.error('Error al guardar evaluación:', error);
                showNotification('Error al guardar la evaluación: ' + error.message, 'error');
            }
        });
    }, 100);
}

// Mostrar evaluación existente
function mostrarEvaluacionExistente(evaluacion, project) {
    const respuestas = JSON.parse(evaluacion.respuestas);
    
    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="closeModal(event)">
            <div class="bg-white rounded-lg w-full max-w-4xl my-8" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-${evaluacion.aprobado ? 'green' : 'red'}-600 to-${evaluacion.aprobado ? 'green' : 'red'}-800 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">
                                <i class="fas fa-file-alt mr-2"></i>
                                Evaluación Final Realizada
                            </h3>
                            <p class="text-${evaluacion.aprobado ? 'green' : 'red'}-100">${project.title}</p>
                            <p class="text-sm text-${evaluacion.aprobado ? 'green' : 'red'}-200 mt-1">
                                Evaluado el ${new Date(evaluacion.created_at).toLocaleDateString('es-ES')}
                            </p>
                        </div>
                        <button onclick="closeModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <div class="bg-${evaluacion.aprobado ? 'green' : 'red'}-50 border-l-4 border-${evaluacion.aprobado ? 'green' : 'red'}-500 p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-lg font-bold text-${evaluacion.aprobado ? 'green' : 'red'}-800">
                                    ${evaluacion.aprobado ? '✓ APROBADO' : '✗ NO APROBADO'}
                                </p>
                                <p class="text-sm text-${evaluacion.aprobado ? 'green' : 'red'}-700">
                                    Porcentaje de cumplimiento: ${evaluacion.porcentaje}%
                                </p>
                            </div>
                            ${evaluacion.pdf_url ? `
                                <a href="${evaluacion.pdf_url}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-download mr-2"></i>Descargar PDF
                                </a>
                            ` : ''}
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <h4 class="font-bold text-gray-800 mb-3">Respuestas de la evaluación:</h4>
                        ${preguntasEvaluacionFinal.map((pregunta, index) => `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <div class="flex items-start gap-3">
                                    <div class="flex items-center justify-center w-7 h-7 rounded-full bg-gray-100 text-gray-700 font-bold flex-shrink-0 text-sm">
                                        ${index + 1}
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-800 mb-2">${pregunta.pregunta}</p>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                                            respuestas[pregunta.id] ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }">
                                            <i class="fas fa-${respuestas[pregunta.id] ? 'check' : 'times'} mr-1"></i>
                                            ${respuestas[pregunta.id] ? 'SÍ' : 'NO'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${evaluacion.observaciones ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm font-semibold text-yellow-800 mb-2">
                                <i class="fas fa-comment-alt mr-1"></i>Observaciones del evaluador:
                            </p>
                            <p class="text-sm text-yellow-700">${evaluacion.observaciones}</p>
                        </div>
                    ` : ''}

                    <div class="flex justify-end gap-3 mt-6">
                        ${evaluacion.pdf_url ? `
                            <button onclick="window.open('${evaluacion.pdf_url}', '_blank')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-file-pdf mr-2"></i>Ver PDF
                            </button>
                        ` : ''}
                        <button onclick="closeModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    render();
}

        // ============================================
        // FUNCIONES DE SUPABASE
        // ============================================
        
        // Login con Supabase
        async function loginUser(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Obtener datos adicionales del usuario desde la tabla users
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (userError) throw userError;

                return userData;
            } catch (error) {
                console.error('Error en login:', error);
                return null;
            }
        }

        // Registrar nuevo usuario (solo Admin) - USANDO EDGE FUNCTION
async function createUser(userData) {
    try {
        console.log('Creando usuario con Edge Function:', userData);
        
        // URL correcta de la Edge Function
        const functionUrl = `${SUPABASE_URL}/functions/v1/create-user`;
        console.log('URL de la función:', functionUrl);
        
        // Llamar a la Edge Function
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({
                email: userData.email,
                password: userData.password,
                name: userData.name,
                role: userData.role
            })
        });

        console.log('Respuesta HTTP:', response.status);
        
        const result = await response.json();
        console.log('Resultado:', result);

        if (!response.ok) {
            throw new Error(result.error || result.details || 'Error al crear usuario');
        }

        console.log('Usuario creado exitosamente:', result);
        showNotification('Usuario creado exitosamente', 'success');
        return result.user;

    } catch (error) {
        console.error('Error completo al crear usuario:', error);
        showNotification('Error: ' + error.message, 'error');
        return null;
    }
}

        // Obtener todos los usuarios
        async function getUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error al obtener usuarios:', error);
                return [];
            }
        }

        // Eliminar usuario
        async function deleteUser(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                return false;
            }
        }

        // Crear proyecto
        async function createProject(projectData) {
    try {
        console.log('Intentando crear proyecto con datos:', projectData);
        console.log('Usuario actual:', state.currentUser);
        
        const { data, error } = await supabase
            .from('projects')
            .insert([{
                docente_id: state.currentUser.id,
                title: projectData.title,
                description: projectData.description,
                type: projectData.type,
                linea_investigacion: projectData.linea_investigacion,
                lugar_ejecucion: projectData.lugar_ejecucion,
                beneficiarios: projectData.beneficiarios,
                costos: parseFloat(projectData.costos),
                fecha_inicio: projectData.fecha_inicio,
                fecha_fin: projectData.fecha_fin,
                status: 'pendiente',
                created_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) {
            console.error('Error de Supabase:', error);
            throw error;
        }
        
        console.log('Proyecto creado exitosamente:', data);
        return data;
    } catch (error) {
        console.error('Error al crear proyecto:', error);
        showNotification('Error: ' + error.message, 'error');
        return null;
    }
}

        // Obtener proyectos según rol
        async function getProjects() {
    try {
        console.log('Obteniendo proyectos para usuario:', state.currentUser);
        
        let query = supabase
            .from('projects')
            .select(`
                *,
                users!projects_docente_id_fkey (
                    name,
                    email
                )
            `);

        if (state.currentUser.role === 'docente') {
            query = query.eq('docente_id', state.currentUser.id);
        }

        query = query.order('created_at', { ascending: false });

        const { data, error } = await query;

        if (error) {
            console.error('Error al obtener proyectos:', error);
            throw error;
        }
        
        console.log('Proyectos obtenidos:', data);
        return data || [];
    } catch (error) {
        console.error('Error en getProjects:', error);
        showNotification('Error al cargar proyectos: ' + error.message, 'error');
        return [];
    }
}

        // Actualizar proyecto
        async function updateProject(projectId, updates) {
            try {
                const { data, error } = await supabase
                    .from('projects')
                    .update(updates)
                    .eq('id', projectId)
                    .select()
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error al actualizar proyecto:', error);
                return null;
            }
        }

        // Subir archivo
        async function uploadFile(file, projectId, type) {
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${projectId}/${type}_${Date.now()}.${fileExt}`;

                const { data, error } = await supabase.storage
                    .from('project-files')
                    .upload(fileName, file);

                if (error) throw error;

                // Obtener URL pública
                const { data: urlData } = supabase.storage
                    .from('project-files')
                    .getPublicUrl(fileName);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Error al subir archivo:', error);
                return null;
            }
        }

        // ============================================
        // FUNCIONES DE NOTIFICACIÓN
        // ============================================
        function showNotification(message, type = 'info') {
            const id = Date.now();
            state.notifications.push({ id, message, type });
            render();

            setTimeout(() => {
                state.notifications = state.notifications.filter(n => n.id !== id);
                render();
            }, 3000);
        }

        // ============================================
        // FUNCIONES DE NAVEGACIÓN
        // ============================================
        function changeView(newView) {
            state.view = newView;
            render();
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            state.currentUser = null;
            state.view = 'login';
            showNotification('Sesión cerrada correctamente', 'success');
        }

        // ============================================
        // COMPONENTES HTML
        // ============================================

        // Notificaciones
        function renderNotifications() {
            if (state.notifications.length === 0) return '';

            return `
                <div class="fixed top-4 right-4 z-50 space-y-2">
                    ${state.notifications.map(n => `
                        <div class="bg-white border-l-4 ${
                            n.type === 'success' ? 'border-green-500' : 
                            n.type === 'error' ? 'border-red-500' : 
                            'border-blue-500'
                        } rounded-lg shadow-lg p-4 flex items-center gap-3 animate-slide-in">
                            <i class="fas ${
                                n.type === 'success' ? 'fa-check-circle text-green-500' : 
                                n.type === 'error' ? 'fa-exclamation-circle text-red-500' : 
                                'fa-info-circle text-blue-500'
                            } text-xl"></i>
                            <p class="text-gray-800">${n.message}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Vista de Login
        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-graduation-cap text-white text-4xl"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800">Sistema de Investigación</h1>
                            <p class="text-gray-600 mt-2">IESTP Huancayo</p>
                        </div>
                        
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Correo Electrónico
                                </label>
                                <input
                                    type="email"
                                    id="loginEmail"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="usuario@iestphuancayo.edu.pe"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Contraseña
                                </label>
                                <input
                                    type="password"
                                    id="loginPassword"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="••••••••"
                                    required
                                />
                            </div>
                            
                            <button
                                type="submit"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                            >
                                Iniciar Sesión
                            </button>
                        </form>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                            </ol>
                        </div>
                    </div>
                </div>
            `;
        }

        // Dashboard del Admin
        function renderAdminDashboard() {
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavbar()}
                    
                    <div class="max-w-7xl mx-auto p-6">
                        <!-- Estadísticas -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                                <i class="fas fa-users text-4xl mb-3"></i>
                                <h3 class="text-3xl font-bold">${state.users.length}</h3>
                                <p class="text-blue-100">Usuarios Totales</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                                <i class="fas fa-project-diagram text-4xl mb-3"></i>
                                <h3 class="text-3xl font-bold">${state.projects.length}</h3>
                                <p class="text-green-100">Proyectos Activos</p>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-xl shadow-lg">
                                <i class="fas fa-clock text-4xl mb-3"></i>
                                <h3 class="text-3xl font-bold">${state.projects.filter(p => p.status === 'pendiente').length}</h3>
                                <p class="text-yellow-100">Pendientes</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                                <i class="fas fa-check-circle text-4xl mb-3"></i>
                                <h3 class="text-3xl font-bold">${state.projects.filter(p => p.status === 'aprobado').length}</h3>
                                <p class="text-purple-100">Aprobados</p>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="bg-white rounded-lg shadow-md mb-6">
                            <div class="border-b border-gray-200">
                                <nav class="flex -mb-px">
                                    <button onclick="changeView('admin-users')" class="px-6 py-4 text-sm font-medium border-b-2 ${state.view === 'admin-users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                                        <i class="fas fa-users mr-2"></i>Gestión de Usuarios
                                    </button>
                                    <button onclick="changeView('admin-projects')" class="px-6 py-4 text-sm font-medium border-b-2 ${state.view === 'admin-projects' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                                        <i class="fas fa-folder mr-2"></i>Gestión de Proyectos
                                    </button>
                                    <button onclick="changeView('admin-settings')" class="px-6 py-4 text-sm font-medium border-b-2 ${state.view === 'admin-settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                                        <i class="fas fa-cog mr-2"></i>Configuración
                                    </button>
                                </nav>
                            </div>
                        </div>

                        <!-- Contenido según tab -->
                        <div id="adminContent">
                            ${state.view === 'admin-users' ? renderUserManagement() : ''}
                            ${state.view === 'admin-projects' ? renderProjectManagement() : ''}
                            ${state.view === 'admin-settings' ? renderSettings() : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Navbar
        function renderNavbar() {
            return `
                <nav class="bg-white shadow-md p-4 mb-6">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-graduation-cap text-blue-600 text-3xl"></i>
                            <div>
                                <h1 class="text-xl font-bold text-gray-800">
                                    ${state.currentUser.role === 'admin' ? 'Panel de Administración' : 
                                      state.currentUser.role === 'docente' ? 'Panel del Docente' :
                                      state.currentUser.role === 'jefe_investigacion' ? 'Panel de Investigación' :
                                      'Panel de Dirección'}
                                </h1>
                                <p class="text-sm text-gray-600">${state.currentUser.name}</p>
                            </div>
                        </div>
                        <button
                            onclick="handleLogout()"
                            class="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                        >
                            <i class="fas fa-sign-out-alt"></i>
                            Cerrar Sesión
                        </button>
                    </div>
                </nav>
            `;
        }

        // Gestión de Usuarios
        function renderUserManagement() {
            return `
            <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-users text-blue-600 mr-2"></i>
            Gestión de Usuarios
        </h2>
        <button
            onclick="openCreateUserModal()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
        >
            <i class="fas fa-user-plus"></i>
            Nuevo Usuario
        </button>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>Buscar usuario
                </label>
                <input 
                    type="text" 
                    id="userSearchInput"
                    placeholder="Buscar por nombre o email..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    oninput="filterUsers()"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-filter mr-1"></i>Filtrar por rol
                </label>
                <select 
                    id="userRoleFilter"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    onchange="filterUsers()"
                >
                    <option value="">Todos los roles</option>
                    <option value="admin">Administrador</option>
                    <option value="docente">Docente</option>
                    <option value="jefe_investigacion">Jefe de Investigación</option>
                    <option value="direccion">Dirección General</option>
                </select>
            </div>
        </div>
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
            <span id="userFilterCount">Mostrando ${state.users.length} de ${state.users.length} usuarios</span>
            <button 
                onclick="clearUserFilters()"
                class="text-blue-600 hover:text-blue-800"
            >
                <i class="fas fa-times-circle mr-1"></i>Limpiar filtros
            </button>
        </div>
    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Registro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="usersTableBody">
    ${state.users.map(user => `
        <tr class="user-row" data-name="${user.name.toLowerCase()}" data-email="${user.email.toLowerCase()}" data-role="${user.role}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                                                    ${user.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 
                                                  user.role === 'docente' ? 'bg-blue-100 text-blue-800' :
                                                  user.role === 'jefe_investigacion' ? 'bg-green-100 text-green-800' :
                                                  'bg-yellow-100 text-yellow-800'}">
                                                ${user.role === 'admin' ? 'Administrador' : 
                                                  user.role === 'docente' ? 'Docente' :
                                                  user.role === 'jefe_investigacion' ? 'Jefe de Investigación' :
                                                  'Dirección General'}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ${user.created_at ? new Date(user.created_at).toLocaleDateString('es-ES') : 'N/A'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            ${user.role !== 'admin' ? `
                                                <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="confirmDeleteUser('${user.id}')" class="text-red-600 hover:text-red-900">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            ` : '<span class="text-gray-400">Protegido</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Gestión de Proyectos (Admin)
        function renderProjectManagement() {
            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-folder-open text-blue-600 mr-2"></i>
                        Todos los Proyectos
                    </h2>

                    <div class="grid grid-cols-1 gap-6">
                        ${state.projects.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-folder-open text-6xl mb-4"></i>
                                <p class="text-xl">No hay proyectos registrados</p>
                            </div>
                        ` : state.projects.map(project => `
                            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h3 class="text-xl font-bold text-gray-800 mb-2">${project.title || 'Sin título'}</h3>
                                        <p class="text-gray-600 mb-2">${project.description || 'Sin descripción'}</p>
                                        <div class="flex items-center gap-4 text-sm text-gray-500">
                                            <span><i class="fas fa-user mr-1"></i>${project.users?.name || 'Sin asignar'}</span>
                                            <span><i class="fas fa-calendar mr-1"></i>${project.created_at ? new Date(project.created_at).toLocaleDateString('es-ES') : 'N/A'}</span>
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold
                                                ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                                  project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                                  project.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                                                  'bg-gray-100 text-gray-800'}">
                                                ${project.status || 'pendiente'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="viewProject('${project.id}')" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-eye text-xl"></i>
                                        </button>
                                        <button onclick="editProject('${project.id}')" class="text-green-600 hover:text-green-800">
                                            <i class="fas fa-edit text-xl"></i>
                                        </button>
                                        <button onclick="confirmDeleteProject('${project.id}')" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Configuración
function renderSettings() {
    return `
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-cog text-blue-600 mr-2"></i>
                Configuración del Sistema
            </h2>

            <div class="space-y-6">
                <!-- Información de Supabase -->
                <div class="border-b pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Conexión a Supabase</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2"><strong>URL:</strong> ${SUPABASE_URL}</p>
                        <p class="text-sm text-gray-600"><strong>Estado:</strong> 
                            <span class="text-green-600 font-semibold">✓ Conectado</span>
                        </p>
                    </div>
                </div>

                <!-- Cronograma -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
        Cronograma General de Entregas 2025
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        ${cronograma.map((item, index) => {
            const fechaLimite = new Date(item.fecha);
            const hoy = new Date();
            const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
            const vencido = diasRestantes < 0;
            const proximo = diasRestantes >= 0 && diasRestantes <= 7;
            
            return `
                <div class="border ${vencido ? 'border-red-300 bg-red-50' : proximo ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200'} rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-semibold ${vencido ? 'text-red-600' : proximo ? 'text-yellow-600' : 'text-gray-500'}">${item.entrega}</span>
                        ${vencido ? '<i class="fas fa-exclamation-triangle text-red-500"></i>' : proximo ? '<i class="fas fa-bell text-yellow-500"></i>' : ''}
                    </div>
                    <p class="text-sm font-bold ${vencido ? 'text-red-700' : proximo ? 'text-yellow-700' : 'text-gray-700'}">${fechaLimite.toLocaleDateString('es-ES')}</p>
                    <p class="text-xs ${vencido ? 'text-red-600' : proximo ? 'text-yellow-600' : 'text-gray-500'} mt-1">
                        ${vencido ? `Vencido hace ${Math.abs(diasRestantes)} días` : proximo ? `Faltan ${diasRestantes} días` : `Faltan ${diasRestantes} días`}
                    </p>
                </div>
            `;
        }).join('')}
    </div>
</div>

<!-- Lista de proyectos con cronograma individual -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-blue-600 mr-2"></i>
        Mis Proyectos y Avances
    </h2>

    ${state.projects.length === 0 ? `
        <div class="text-center py-12 text-gray-500">
            <i class="fas fa-folder-open text-6xl mb-4"></i>
            <p class="text-xl mb-2">No tienes proyectos registrados</p>
            <p class="text-sm">Crea tu primer proyecto de investigación</p>
        </div>
    ` : `
        <div class="space-y-6">
            ${state.projects.map(project => `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <!-- Cabecera del proyecto -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${project.title || 'Sin título'}</h3>
                            <p class="text-sm text-gray-600 mb-3">${project.description || 'Sin descripción'}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span><i class="fas fa-tag mr-1"></i>${project.type === 'investigacion_aplicada' ? 'Investigación Aplicada' : project.type === 'innovacion_tecnologica' ? 'Innovación Tecnológica' : 'Innovación Pedagógica'}</span>
                                <span><i class="fas fa-calendar mr-1"></i>${project.fecha_inicio ? new Date(project.fecha_inicio).toLocaleDateString('es-ES') : 'N/A'}</span>
                                <span class="px-2 py-1 rounded-full font-semibold
                                    ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                      project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                      project.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${project.status || 'pendiente'}
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="viewProjectDetail('${project.id}')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editProject('${project.id}')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Cronograma de avances del proyecto -->
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-tasks text-blue-500 mr-2"></i>
                            Cronograma de Avances
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${cronograma.map((item, index) => {
                                const fechaLimite = new Date(item.fecha);
                                const hoy = new Date();
                                const vencido = fechaLimite < hoy;
                                const proximo = !vencido && Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24)) <= 7;
                                
                                // Aquí podrías verificar si el avance fue subido (por ahora simulado)
                                const avanceSubido = false; // Cambiar cuando implementes la tabla de avances
                                
                                return `
                                    <div class="relative border-2 ${
                                        avanceSubido ? 'border-green-500 bg-green-50' :
                                        vencido ? 'border-red-300 bg-red-50' : 
                                        proximo ? 'border-yellow-300 bg-yellow-50' : 
                                        'border-gray-200 bg-white'
                                    } rounded-lg p-3 text-center hover:shadow-md transition-shadow cursor-pointer" 
                                    onclick="uploadAdvance('${project.id}', ${index + 1}, '${item.entrega}')">
                                        ${avanceSubido ? '<div class="absolute top-1 right-1"><i class="fas fa-check-circle text-green-500"></i></div>' : ''}
                                        <div class="text-xs font-semibold ${
                                            avanceSubido ? 'text-green-700' :
                                            vencido ? 'text-red-600' : 
                                            proximo ? 'text-yellow-600' : 
                                            'text-gray-600'
                                        } mb-1">${item.entrega}</div>
                                        <div class="text-xs ${
                                            avanceSubido ? 'text-green-600' :
                                            vencido ? 'text-red-500' : 
                                            proximo ? 'text-yellow-500' : 
                                            'text-gray-500'
                                        }">${fechaLimite.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}</div>
                                        <div class="mt-2">
                                            ${avanceSubido ? 
                                                '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">Entregado</span>' :
                                                '<button class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600"><i class="fas fa-upload mr-1"></i>Subir</button>'
                                            }
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `}
</div>

                <!-- Instrucciones -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Información Importante
                    </h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-gray-700 mb-2">
                            <strong>✓</strong> La configuración de la base de datos se realiza directamente en Supabase
                        </p>
                        <p class="text-sm text-gray-700">
                            <strong>✓</strong> Consulta el archivo SQL proporcionado separadamente para configurar las tablas
                        </p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

        // Dashboard del Docente
        function renderDocenteDashboard() {
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavbar()}
                    
                    <div class="max-w-7xl mx-auto p-6">
                        <!-- Estadísticas del docente -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                                <i class="fas fa-folder text-blue-500 text-3xl mb-2"></i>
                                <h3 class="text-2xl font-bold">${state.projects.length}</h3>
                                <p class="text-gray-600">Mis Proyectos</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                                <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                                <h3 class="text-2xl font-bold">${state.projects.filter(p => p.status === 'aprobado').length}</h3>
                                <p class="text-gray-600">Aprobados</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                                <i class="fas fa-clock text-yellow-500 text-3xl mb-2"></i>
                                <h3 class="text-2xl font-bold">${state.projects.filter(p => p.status === 'pendiente').length}</h3>
                                <p class="text-gray-600">En Revisión</p>
                            </div>
                        </div>

                        <!-- Botón crear proyecto -->
                        <div class="mb-6">
                            <button
                                onclick="openCreateProjectModal()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center gap-2 font-semibold"
                            >
                                <i class="fas fa-plus"></i>
                                Nuevo Proyecto de Investigación
                            </button>
                        </div>

                        
                        <!-- Lista de proyectos -->
                        <!-- Lista de proyectos -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-blue-600 mr-2"></i>
        Mis Proyectos
    </h2>

    <!-- Filtros de búsqueda -->
    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>Buscar proyecto
                </label>
                <input 
                    type="text" 
                    id="projectSearchInput"
                    placeholder="Buscar por título o descripción..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    oninput="filterProjects()"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-filter mr-1"></i>Filtrar por estado
                </label>
                <select 
                    id="projectStatusFilter"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    onchange="filterProjects()"
                >
                    <option value="">Todos los estados</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="aprobado">Aprobado</option>
                    <option value="observado">Observado</option>
                    <option value="rechazado">Rechazado</option>
                </select>
            </div>
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-tag mr-1"></i>Filtrar por tipo
            </label>
            <div class="flex flex-wrap gap-2">
                <button 
                    onclick="filterProjectsByType('')"
                    class="px-3 py-1 text-xs rounded-full border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors"
                    id="typeFilter_all"
                >
                    Todos
                </button>
                <button 
                    onclick="filterProjectsByType('investigacion_aplicada')"
                    class="px-3 py-1 text-xs rounded-full border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors"
                    id="typeFilter_investigacion_aplicada"
                >
                    Investigación Aplicada
                </button>
                <button 
                    onclick="filterProjectsByType('innovacion_tecnologica')"
                    class="px-3 py-1 text-xs rounded-full border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors"
                    id="typeFilter_innovacion_tecnologica"
                >
                    Innovación Tecnológica
                </button>
                <button 
                    onclick="filterProjectsByType('innovacion_pedagogica')"
                    class="px-3 py-1 text-xs rounded-full border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-colors"
                    id="typeFilter_innovacion_pedagogica"
                >
                    Innovación Pedagógica
                </button>
            </div>
        </div>
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
            <span id="projectFilterCount">Mostrando ${state.projects.length} de ${state.projects.length} proyectos</span>
            <button 
                onclick="clearProjectFilters()"
                class="text-blue-600 hover:text-blue-800"
            >
                <i class="fas fa-times-circle mr-1"></i>Limpiar filtros
            </button>
        </div>
    </div>

                            ${state.projects.length === 0 ? `
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fas fa-folder-open text-6xl mb-4"></i>
                                    <p class="text-xl mb-2">No tienes proyectos registrados</p>
                                    <p class="text-sm">Crea tu primer proyecto de investigación</p>
                                </div>
                                ` : `
    <div class="space-y-4" id="projectsContainer">
        ${state.projects.map(project => `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow project-row" 
                 data-title="${(project.title || '').toLowerCase()}" 
                 data-description="${(project.description || '').toLowerCase()}"
                 data-status="${project.status || 'pendiente'}"
                 data-type="${project.type || ''}">
    <div class="flex justify-between items-start">
        <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2">${project.title || 'Sin título'}</h3>
            <p class="text-sm text-gray-600 mb-3">${project.description || 'Sin descripción'}</p>
            <div class="flex items-center gap-4 text-xs text-gray-500">
                <span><i class="fas fa-tag mr-1"></i>${project.type === 'investigacion_aplicada' ? 'Investigación Aplicada' : project.type === 'innovacion_tecnologica' ? 'Innovación Tecnológica' : 'Innovación Pedagógica'}</span>
                <span><i class="fas fa-calendar mr-1"></i>${project.fecha_inicio ? new Date(project.fecha_inicio).toLocaleDateString('es-ES') : 'N/A'}</span>
                <span class="px-2 py-1 rounded-full font-semibold
                    ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                      project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                      project.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'}">
                    ${project.status || 'pendiente'}
                </span>
            </div>
            
            ${project.status === 'observado' && project.observaciones ? `
                <div class="mt-3 bg-yellow-50 border-l-4 border-yellow-500 rounded p-3">
                    <p class="text-xs font-bold text-yellow-800 mb-1">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Observaciones del evaluador:
                    </p>
                    <p class="text-sm text-yellow-700">${project.observaciones}</p>
                    <p class="text-xs text-yellow-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Puede editar y corregir el proyecto para una nueva evaluación
                    </p>
                </div>
            ` : ''}
            
            ${project.status === 'rechazado' && project.observaciones ? `
                <div class="mt-3 bg-red-50 border-l-4 border-red-500 rounded p-3">
                    <p class="text-xs font-bold text-red-800 mb-1">
                        <i class="fas fa-times-circle mr-1"></i>
                        Proyecto rechazado - Motivo:
                    </p>
                    <p class="text-sm text-red-700">${project.observaciones}</p>
                </div>
            ` : ''}
        </div>
        <div class="flex gap-2 ml-4">
            <button onclick="viewProjectDetail('${project.id}')" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600" title="Ver detalle">
                <i class="fas fa-eye"></i>
            </button>
            <button onclick="viewProjectSchedule('${project.id}')" class="bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600" title="Ver cronograma">
                <i class="fas fa-calendar-alt"></i>
            </button>
            ${project.status !== 'aprobado' && project.status !== 'rechazado' ? `
                <button onclick="editProject('${project.id}')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
            ` : `
                <button class="bg-gray-400 text-white px-3 py-2 rounded cursor-not-allowed" title="No se puede editar" disabled>
                    <i class="fas fa-lock"></i>
                </button>
            `}
        </div>
    </div>
</div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Dashboard Jefe de Investigación
        function renderJefeDashboard() {
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavbar()}
                    
                    <div class="max-w-7xl mx-auto p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">
                            <i class="fas fa-clipboard-check text-blue-600 mr-2"></i>
                            Proyectos para Evaluar
                        </h2>

                        <div class="grid grid-cols-1 gap-6">
                            ${state.projects.length === 0 ? `
                                <div class="bg-white rounded-lg shadow-md p-12 text-center text-gray-500">
                                    <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                                    <p class="text-xl">No hay proyectos para evaluar</p>
                                </div>
                            ` : state.projects.map(project => `
                                <div class="bg-white border-l-4 ${
                                    project.status === 'pendiente' ? 'border-yellow-500' :
                                    project.status === 'aprobado' ? 'border-green-500' :
                                    project.status === 'observado' ? 'border-orange-500' :
                                    'border-red-500'
                                } rounded-lg shadow-md p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${project.title || 'Sin título'}</h3>
                                            <p class="text-gray-600 mb-3">${project.description || 'Sin descripción'}</p>
                                            <div class="flex items-center gap-4 text-sm text-gray-500 mb-3">
                                                <span><i class="fas fa-user mr-1"></i>${project.users?.name || 'Sin asignar'}</span>
                                                <span><i class="fas fa-tag mr-1"></i>${project.type === 'investigacion_aplicada' ? 'Investigación Aplicada' : project.type === 'innovacion_tecnologica' ? 'Innovación Tecnológica' : 'Innovación Pedagógica'}</span>
                                                <span><i class="fas fa-calendar mr-1"></i>${project.created_at ? new Date(project.created_at).toLocaleDateString('es-ES') : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                                            ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                              project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                              project.status === 'observado' ? 'bg-orange-100 text-orange-800' :
                                              'bg-yellow-100 text-yellow-800'}">
                                            ${project.status || 'Pendiente'}
                                        </span>
                                    </div>
                                    
                                    <div class="flex gap-3">
    ${project.status === 'aprobado' || project.status === 'rechazado' ? `
        <!-- Proyecto con evaluación final -->
        <div class="flex-1 bg-gray-100 border-2 border-gray-300 rounded-lg p-4 text-center">
            <i class="fas ${project.status === 'aprobado' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} text-3xl mb-2"></i>
            <p class="font-bold text-gray-800">
                ${project.status === 'aprobado' ? 'Proyecto Aprobado' : 'Proyecto Rechazado'}
            </p>
            <p class="text-xs text-gray-600 mt-1">Evaluación finalizada</p>
            ${project.observaciones ? `
                <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded p-2 text-left">
                    <p class="text-xs font-semibold text-yellow-800">
                        <i class="fas fa-comment mr-1"></i>Observaciones finales:
                    </p>
                    <p class="text-xs text-yellow-700 mt-1">${project.observaciones}</p>
                </div>
            ` : ''}
        </div>
    ` : `
        <!-- Proyecto pendiente u observado - Puede evaluarse -->
        <button onclick="evaluateProject('${project.id}', 'aprobado')" class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            <i class="fas fa-check mr-2"></i>Aprobar Proyecto
        </button>
        <button onclick="evaluateProject('${project.id}', 'observado')" class="flex-1 bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
            <i class="fas fa-eye mr-2"></i>Observar
        </button>
        <button onclick="evaluateProject('${project.id}', 'rechazado')" class="flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            <i class="fas fa-times mr-2"></i>Rechazar
        </button>
    `}
    <button onclick="viewProjectDetail('${project.id}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        <i class="fas fa-file-alt"></i>
    </button>
    <button onclick="viewProjectScheduleEvaluator('${project.id}')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600" title="Evaluar avances">
        <i class="fas fa-tasks"></i>
    </button>
</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Dashboard Dirección General
        function renderDireccionDashboard() {
            const proyectosAprobados = state.projects.filter(p => p.status === 'aprobado');
            
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavbar()}
                    
                    <div class="max-w-7xl mx-auto p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">
                            <i class="fas fa-stamp text-blue-600 mr-2"></i>
                            Proyectos Aprobados - Aprobación Final
                        </h2>

                        <div class="grid grid-cols-1 gap-6">
                            ${proyectosAprobados.length === 0 ? `
                                <div class="bg-white rounded-lg shadow-md p-12 text-center text-gray-500">
                                    <i class="fas fa-folder-open text-6xl mb-4"></i>
                                    <p class="text-xl">No hay proyectos aprobados pendientes de publicación</p>
                                </div>
                            ` : proyectosAprobados.map(project => `
                                <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-md p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${project.title || 'Sin título'}</h3>
                                            <p class="text-gray-600 mb-3">${project.description || 'Sin descripción'}</p>
                                            <div class="flex items-center gap-4 text-sm text-gray-500">
                                                <span><i class="fas fa-user mr-1"></i>${project.users?.name || 'Sin asignar'}</span>
                                                <span><i class="fas fa-check-circle text-green-500 mr-1"></i>Aprobado por Jefe de Investigación</span>
                                            </div>
                                        </div>
                                        ${project.publicado ? `
                                            <span class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                                                <i class="fas fa-globe mr-1"></i>Publicado
                                            </span>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex gap-3">
                                        <button onclick="viewProjectDetail('${project.id}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                            <i class="fas fa-eye mr-2"></i>Ver Detalle
                                        </button>
                                        ${!project.publicado ? `
                                            <button onclick="publishProject('${project.id}')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                                <i class="fas fa-check-double mr-2"></i>Aprobar y Publicar
                                            </button>
                                        ` : `
                                            <button class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed" disabled>
                                                <i class="fas fa-check-double mr-2"></i>Ya Publicado
                                            </button>
                                        `}
                                        <button onclick="downloadProject('${project.id}')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                                            <i class="fas fa-download mr-2"></i>Descargar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal para crear usuario
function openCreateUserModal() {
    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
            <div class="bg-white rounded-lg p-6 w-full max-w-md" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-user-plus text-blue-600 mr-2"></i>
                        Crear Nuevo Usuario
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="createUserForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input type="text" id="userFirstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Juan" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
                            <input type="text" id="userLastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Pérez López" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre para mostrar</label>
                        <input type="text" id="userDisplayName" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700" readonly>
                        <p class="text-xs text-gray-500 mt-1">Se genera automáticamente</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de usuario</label>
                        <input type="text" id="userUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: jperez" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dominio</label>
                        <select id="userDomain" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="@institutocajas.edu.pe">@institutocajas.edu.pe </option>
                            <option value="@jefecajas.edu.pe">@jefecajas.edu.pe </option>
                            <option value="@direccioncajas.edu.pe">@direccioncajas.edu.pe </option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="userEmail" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700" readonly>
                        <p class="text-xs text-gray-500 mt-1">Se genera automáticamente</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                        <input type="text" id="userRoleDisplay" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700" readonly>
                        <input type="hidden" id="userRole">
                        <p class="text-xs text-gray-500 mt-1">Se asigna automáticamente según el dominio</p>
                    </div>
                    
                    <div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="autoPassword" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                            <span class="text-sm text-gray-700">Crear una contraseña de manera automática</span>
                        </label>
                    </div>
                    
                    <div id="passwordField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="userPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Crear Usuario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    render();

    // Agregar event listeners al form
    setTimeout(() => {
        const firstNameInput = document.getElementById('userFirstName');
        const lastNameInput = document.getElementById('userLastName');
        const displayNameInput = document.getElementById('userDisplayName');
        const usernameInput = document.getElementById('userUsername');
        const domainSelect = document.getElementById('userDomain');
        const emailInput = document.getElementById('userEmail');
        const roleInput = document.getElementById('userRole');
        const roleDisplayInput = document.getElementById('userRoleDisplay');
        const autoPasswordCheck = document.getElementById('autoPassword');
        const passwordField = document.getElementById('passwordField');

        // Función para actualizar nombre completo
        function updateDisplayName() {
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            if (firstName && lastName) {
                displayNameInput.value = `${firstName} ${lastName}`;
            } else if (firstName) {
                displayNameInput.value = firstName;
            } else {
                displayNameInput.value = '';
            }
        }

        // Función para actualizar email
        function updateEmail() {
            const username = usernameInput.value.trim();
            const domain = domainSelect.value;
            if (username) {
                emailInput.value = username + domain;
            } else {
                emailInput.value = '';
            }
        }

        // Función para actualizar rol según dominio
        function updateRole() {
            const domain = domainSelect.value;
            let role = '';
            let roleDisplay = '';
            
            if (domain === '@institutocajas.edu.pe') {
                role = 'docente';
                roleDisplay = 'Docente Investigador';
            } else if (domain === '@jefecajas.edu.pe') {
                role = 'jefe_investigacion';
                roleDisplay = 'Jefe de Investigación';
            } else if (domain === '@direccioncajas.edu.pe') {
                role = 'direccion';
                roleDisplay = 'Dirección General';
            }
            
            roleInput.value = role;
            roleDisplayInput.value = roleDisplay;
        }

        // Event listeners
        firstNameInput.addEventListener('input', updateDisplayName);
        lastNameInput.addEventListener('input', updateDisplayName);
        usernameInput.addEventListener('input', updateEmail);
        domainSelect.addEventListener('change', () => {
            updateEmail();
            updateRole();
        });

        // Toggle contraseña manual
        autoPasswordCheck.addEventListener('change', (e) => {
            if (e.target.checked) {
                passwordField.classList.add('hidden');
            } else {
                passwordField.classList.remove('hidden');
            }
        });

        // Inicializar rol por defecto
        updateRole();

        // Submit form
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Generar contraseña automática si está marcado
            let password;
            if (autoPasswordCheck.checked) {
                password = generateRandomPassword();
            } else {
                password = document.getElementById('userPassword').value;
                if (!password) {
                    showNotification('Debe ingresar una contraseña', 'error');
                    return;
                }
            }
            
            const userData = {
                name: displayNameInput.value,
                email: emailInput.value,
                password: password,
                role: roleInput.value
            };

            const result = await createUser(userData);
            if (result) {
                showNotification('Usuario creado exitosamente', 'success');
                if (autoPasswordCheck.checked) {
                    showNotification(`Contraseña generada: ${password}`, 'info');
                }
                state.users = await getUsers();
                closeModal();
            } else {
                showNotification('Error al crear usuario', 'error');
            }
        });
    }, 100);
}
// Función para generar contraseña aleatoria
function generateRandomPassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

        // Modal para crear proyecto
function openCreateProjectModal() {
    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="closeModal(event)">
            <div class="bg-white rounded-lg p-6 w-full max-w-3xl m-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-folder-plus text-blue-600 mr-2"></i>
                        Nuevo Proyecto de Investigación
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="createProjectForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título del Proyecto</label>
                            <input type="text" id="projectTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <textarea id="projectDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto</label>
                            <select id="projectType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="investigacion_aplicada">Investigación Aplicada</option>
                                <option value="innovacion_tecnologica">Innovación Tecnológica</option>
                                <option value="innovacion_pedagogica">Innovación Pedagógica</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Línea de Investigación</label>
                            <input type="text" id="projectLinea" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lugar de Ejecución</label>
                            <input type="text" id="projectLugar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beneficiarios</label>
                            <input type="text" id="projectBeneficiarios" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costos Estimados (S/)</label>
                            <input type="number" id="projectCostos" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                            <input type="date" id="projectFechaInicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                            <input type="date" id="projectFechaFin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <!-- Sección de Integrantes -->
                    <div class="border-t pt-4 mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">
                                <i class="fas fa-users mr-1"></i>Integrantes del Proyecto
                            </label>
                            <button type="button" onclick="addIntegranteField()" class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Agregar Integrante
                            </button>
                        </div>
                        <div id="integrantesContainer" class="space-y-2">
                            <div class="flex gap-2 integrante-row">
                                <input type="text" placeholder="Nombre completo del integrante" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 integrante-input">
                                <button type="button" onclick="removeIntegranteField(this)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Agregue los nombres completos de todos los integrantes del equipo de investigación
                        </p>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Crear Proyecto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    render();

    // Agregar event listener al form
    setTimeout(() => {
        document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Recopilar integrantes
            const integrantesInputs = document.querySelectorAll('.integrante-input');
            const integrantes = [];
            integrantesInputs.forEach(input => {
                if (input.value.trim()) {
                    integrantes.push(input.value.trim());
                }
            });
            
            const projectData = {
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                type: document.getElementById('projectType').value,
                linea_investigacion: document.getElementById('projectLinea').value,
                lugar_ejecucion: document.getElementById('projectLugar').value,
                beneficiarios: document.getElementById('projectBeneficiarios').value,
                costos: document.getElementById('projectCostos').value,
                fecha_inicio: document.getElementById('projectFechaInicio').value,
                fecha_fin: document.getElementById('projectFechaFin').value,
                integrantes: JSON.stringify(integrantes)
            };

            const result = await createProject(projectData);
            if (result) {
                showNotification('Proyecto creado exitosamente', 'success');
                state.projects = await getProjects();
                closeModal();
            } else {
                showNotification('Error al crear proyecto', 'error');
            }
        });
    }, 100);
}
// Función para agregar campo de integrante
function addIntegranteField() {
    const container = document.getElementById('integrantesContainer');
    const newRow = document.createElement('div');
    newRow.className = 'flex gap-2 integrante-row';
    newRow.innerHTML = `
        <input type="text" placeholder="Nombre completo del integrante" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 integrante-input">
        <button type="button" onclick="removeIntegranteField(this)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(newRow);
}

// Función para eliminar campo de integrante
function removeIntegranteField(button) {
    const container = document.getElementById('integrantesContainer');
    const rows = container.querySelectorAll('.integrante-row');
    
    // No permitir eliminar si solo hay un campo
    if (rows.length > 1) {
        button.parentElement.remove();
    } else {
        showNotification('Debe haber al menos un integrante', 'error');
    }
}

        // Funciones auxiliares
        function closeModal(event) {
            if (!event || event.target === event.currentTarget) {
                state.showModal = false;
                state.modalContent = null;
                render();
            }
        }

        async function confirmDeleteUser(userId) {
            if (confirm('¿Estás seguro de eliminar este usuario?')) {
                const result = await deleteUser(userId);
                if (result) {
                    showNotification('Usuario eliminado exitosamente', 'success');
                    state.users = await getUsers();
                    render();
                } else {
                    showNotification('Error al eliminar usuario', 'error');
                }
            }
        }

        async function evaluateProject(projectId, newStatus) {
    let observaciones = null;
    
    // Si es observado o rechazado, pedir observaciones obligatorias
    if (newStatus === 'observado' || newStatus === 'rechazado') {
        observaciones = prompt('Ingrese observaciones (obligatorio):');
        if (!observaciones || observaciones.trim() === '') {
            showNotification('Debe ingresar observaciones', 'error');
            return;
        }
    }
    
    // Confirmar la acción
    const confirmMessages = {
        'aprobado': '¿Está seguro de aprobar este proyecto? Esta acción es definitiva.',
        'rechazado': '¿Está seguro de rechazar este proyecto? Esta acción es definitiva.',
        'observado': '¿Enviar observaciones al docente? El docente podrá corregir y reenviar.'
    };
    
    if (!confirm(confirmMessages[newStatus])) {
        return;
    }
    
    const updateData = {
        status: newStatus,
        observaciones: observaciones,
        evaluado_por: state.currentUser.id,
        fecha_evaluacion: new Date().toISOString()
    };
    
    // Si es aprobado o rechazado, marcarlo como final
    if (newStatus === 'aprobado' || newStatus === 'rechazado') {
        updateData.evaluacion_final = true;
    }
    
    const result = await updateProject(projectId, updateData);

    if (result) {
        const messages = {
            'aprobado': 'Proyecto aprobado exitosamente',
            'rechazado': 'Proyecto rechazado. El docente ha sido notificado.',
            'observado': 'Observaciones enviadas. El docente puede corregir y reenviar.'
        };
        showNotification(messages[newStatus], 'success');
        state.projects = await getProjects();
        render();
    } else {
        showNotification('Error al evaluar proyecto', 'error');
    }
}

        async function publishProject(projectId) {
            if (confirm('¿Aprobar y publicar este proyecto?')) {
                const result = await updateProject(projectId, {
                    publicado: true,
                    fecha_publicacion: new Date().toISOString(),
                    aprobado_direccion: true
                });

                if (result) {
                    showNotification('Proyecto publicado exitosamente', 'success');
                    state.projects = await getProjects();
                    render();
                } else {
                    showNotification('Error al publicar proyecto', 'error');
                }
            }
        }
        // Función para que el evaluador vea y evalúe los avances
        async function viewProjectScheduleEvaluator(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;

            if (!project.fecha_inicio || !project.fecha_fin) {
                showNotification('El proyecto no tiene fechas definidas', 'error');
                return;
            }

            const cronogramaProyecto = generarCronograma(project.fecha_inicio, project.fecha_fin);
            const avancesAprobados = await verificarAvancesAprobados(projectId);
            const evaluacionFinal = await verificarEvaluacionFinal(projectId);
            
            const { data: avancesData } = await supabase
                .from('avances')
                .select('*')
                .eq('project_id', projectId)
                .order('numero_avance', { ascending: true });

            state.showModal = true;
            state.modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="closeModal(event)">
                    <div class="bg-white rounded-lg w-full max-w-6xl my-8" onclick="event.stopPropagation()">
                        <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 rounded-t-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-2xl font-bold mb-2">
                                        <i class="fas fa-clipboard-check mr-2"></i>
                                        Evaluación de Avances
                                    </h3>
                                    <p class="text-purple-100">${project.title}</p>
                                    <p class="text-sm text-purple-200 mt-1">
                                        <i class="fas fa-user mr-1"></i>${project.users?.name || 'Sin asignar'}
                                    </p>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="p-6">
                            <div class="mb-6">
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                                    <span>
                                        <i class="fas fa-tasks text-purple-600 mr-2"></i>
                                        Avances Entregados (1-6)
                                    </span>
                                    <span class="text-sm font-normal text-gray-600">
                                        ${avancesData?.filter(a => a.numero_avance <= 6 && a.status === 'aprobado').length || 0} de 6 aprobados
                                    </span>
                                </h4>
                                
                                <div class="space-y-3">
                                    ${cronogramaProyecto.map((item, index) => {
                                        const avance = avancesData?.find(a => a.numero_avance === index + 1);
                                        const fechaLimite = new Date(item.fecha);
                                        
                                        return `
                                            <div class="border-2 ${
                                                !avance ? 'border-gray-200 bg-gray-50' :
                                                avance.status === 'aprobado' ? 'border-green-300 bg-green-50' :
                                                avance.status === 'rechazado' ? 'border-red-300 bg-red-50' :
                                                avance.status === 'observado' ? 'border-yellow-300 bg-yellow-50' :
                                                'border-blue-300 bg-blue-50'
                                            } rounded-lg p-4">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-3 flex-1">
                                                        <div class="flex items-center justify-center w-10 h-10 rounded-full ${
                                                            !avance ? 'bg-gray-300 text-gray-600' :
                                                            avance.status === 'aprobado' ? 'bg-green-200 text-green-700' :
                                                            avance.status === 'rechazado' ? 'bg-red-200 text-red-700' :
                                                            avance.status === 'observado' ? 'bg-yellow-200 text-yellow-700' :
                                                            'bg-blue-200 text-blue-700'
                                                        } font-bold">
                                                            ${index + 1}
                                                        </div>
                                                        
                                                        <div class="flex-1">
                                                            <h5 class="font-bold text-gray-800">${item.entrega}</h5>
                                                            <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                                                                <span>
                                                                    <i class="fas fa-calendar mr-1"></i>
                                                                    ${fechaLimite.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}
                                                                </span>
                                                                ${avance ? `
                                                                    <span>
                                                                        <i class="fas fa-clock mr-1"></i>
                                                                        Entregado: ${new Date(avance.created_at).toLocaleDateString('es-ES')}
                                                                    </span>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    ${!avance ? `
                                                        <span class="text-sm text-gray-500 italic">Sin entregar</span>
                                                    ` : `
                                                        <div class="flex items-center gap-2">
                                                            <a href="${avance.archivo_url}" target="_blank" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">
                                                                <i class="fas fa-download mr-1"></i>Descargar
                                                            </a>
                                                            ${avance.status === 'pendiente' || avance.status === 'observado' ? `
                                                                <button onclick="evaluateAdvance('${avance.id}', 'aprobado')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button onclick="evaluateAdvance('${avance.id}', 'observado')" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 text-sm">
                                                                    <i class="fas fa-exclamation"></i>
                                                                </button>
                                                                <button onclick="evaluateAdvance('${avance.id}', 'rechazado')" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            ` : `
                                                                <span class="px-3 py-2 rounded text-xs font-semibold ${
                                                                    avance.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                                                    'bg-red-100 text-red-800'
                                                                }">
                                                                    ${avance.status === 'aprobado' ? 'Aprobado' : 'Rechazado'}
                                                                </span>
                                                            `}
                                                        </div>
                                                    `}
                                                </div>
                                                
                                                ${avance?.observaciones ? `
                                                    <div class="mt-2 bg-yellow-50 border border-yellow-200 rounded p-2">
                                                        <p class="text-xs font-semibold text-yellow-800">
                                                            <i class="fas fa-comment mr-1"></i>Observaciones:
                                                        </p>
                                                        <p class="text-xs text-yellow-700 mt-1">${avance.observaciones}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-200 my-6"></div>
${avancesAprobados ? `
    <div class="mb-6">
        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-clipboard-check text-purple-600 mr-2"></i>
            Evaluación Pre-Informe Final
        </h4>
        
        ${evaluacionFinal ? `
            <div class="bg-${evaluacionFinal.aprobado ? 'green' : 'red'}-50 border-2 border-${evaluacionFinal.aprobado ? 'green' : 'red'}-300 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-${evaluacionFinal.aprobado ? 'green' : 'red'}-200 text-${evaluacionFinal.aprobado ? 'green' : 'red'}-700">
                            <i class="fas fa-${evaluacionFinal.aprobado ? 'check-circle' : 'times-circle'} text-2xl"></i>
                        </div>
                        <div>
                            <p class="font-bold text-${evaluacionFinal.aprobado ? 'green' : 'red'}-800 text-lg">
                                ${evaluacionFinal.aprobado ? '✓ EVALUACIÓN APROBADA' : '✗ EVALUACIÓN NO APROBADA'}
                            </p>
                            <p class="text-sm text-${evaluacionFinal.aprobado ? 'green' : 'red'}-700">
                                Cumplimiento: ${evaluacionFinal.porcentaje}% - Evaluado el ${new Date(evaluacionFinal.created_at).toLocaleDateString('es-ES')}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="closeModal(); setTimeout(() => openEvaluacionFinalModal('${projectId}'), 300)" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-eye mr-1"></i>Ver Evaluación
                        </button>
                        ${evaluacionFinal.pdf_url ? `
                            <a href="${evaluacionFinal.pdf_url}" target="_blank" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                                <i class="fas fa-file-pdf mr-1"></i>PDF
                            </a>
                        ` : ''}
                    </div>
                </div>
            </div>
        ` : `
            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 text-center">
                <i class="fas fa-clipboard-list text-blue-500 text-4xl mb-3"></i>
                <h5 class="font-bold text-blue-800 mb-2">Evaluación Pendiente</h5>
                <p class="text-sm text-blue-700 mb-4">
                    Todos los avances están aprobados. Realice la evaluación final para habilitar el informe final.
                </p>
                <button onclick="closeModal(); setTimeout(() => openEvaluacionFinalModal('${projectId}'), 300)" 
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                    <i class="fas fa-clipboard-check mr-2"></i>Realizar Evaluación Final
                </button>
            </div>
        `}
    </div>
    
    <div class="border-t-2 border-gray-200 my-6"></div>
` : ''}
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-file-alt text-purple-600 mr-2"></i>
                                    Informe Final
                                </h4>
                                
                                ${(() => {
                                    const informeFinal = avancesData?.find(a => a.numero_avance === 7);
                                    
                                    if (!informeFinal) {
                                        return `
                                            <div class="bg-gray-100 border-2 border-gray-300 rounded-lg p-6 text-center">
                                                <i class="fas fa-hourglass-half text-gray-400 text-3xl mb-2"></i>
                                                <p class="text-gray-600">
                                                    ${!avancesAprobados ? 
                                                        'El informe final estará disponible cuando todos los avances sean aprobados' :
                                                        'El docente aún no ha entregado el informe final'}
                                                </p>
                                            </div>
                                        `;
                                    }
                                    
                                    return `
                                        <div class="border-2 ${
                                            informeFinal.status === 'aprobado' ? 'border-green-300 bg-green-50' :
                                            informeFinal.status === 'rechazado' ? 'border-red-300 bg-red-50' :
                                            informeFinal.status === 'observado' ? 'border-yellow-300 bg-yellow-50' :
                                            'border-blue-300 bg-blue-50'
                                        } rounded-lg p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3 flex-1">
                                                    <div class="flex items-center justify-center w-10 h-10 rounded-full ${
                                                        informeFinal.status === 'aprobado' ? 'bg-green-200 text-green-700' :
                                                        informeFinal.status === 'rechazado' ? 'bg-red-200 text-red-700' :
                                                        informeFinal.status === 'observado' ? 'bg-yellow-200 text-yellow-700' :
                                                        'bg-blue-200 text-blue-700'
                                                    } font-bold">
                                                        <i class="fas fa-flag-checkered"></i>
                                                    </div>
                                                    
                                                    <div class="flex-1">
                                                        <h5 class="font-bold text-gray-800">Informe Final del Proyecto</h5>
                                                        <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                                                            <span>
                                                                <i class="fas fa-clock mr-1"></i>
                                                                Entregado: ${new Date(informeFinal.created_at).toLocaleDateString('es-ES')}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-file mr-1"></i>
                                                                ${informeFinal.archivo_nombre}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="flex items-center gap-2">
                                                    <a href="${informeFinal.archivo_url}" target="_blank" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">
                                                        <i class="fas fa-download mr-1"></i>Descargar
                                                    </a>
                                                    ${informeFinal.status === 'pendiente' || informeFinal.status === 'observado' ? `
                                                        <button onclick="evaluateAdvance('${informeFinal.id}', 'aprobado')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">
                                                            <i class="fas fa-check mr-1"></i>Aprobar
                                                        </button>
                                                        <button onclick="evaluateAdvance('${informeFinal.id}', 'observado')" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 text-sm">
                                                            <i class="fas fa-exclamation mr-1"></i>Observar
                                                        </button>
                                                        <button onclick="evaluateAdvance('${informeFinal.id}', 'rechazado')" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">
                                                            <i class="fas fa-times mr-1"></i>Rechazar
                                                        </button>
                                                    ` : `
                                                        <span class="px-3 py-2 rounded text-xs font-semibold ${
                                                            informeFinal.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                                            'bg-red-100 text-red-800'
                                                        }">
                                                            ${informeFinal.status === 'aprobado' ? 'Aprobado' : 'Rechazado'}
                                                        </span>
                                                    `}
                                                </div>
                                            </div>
                                            
                                            ${informeFinal.observaciones ? `
                                                <div class="mt-2 bg-yellow-50 border border-yellow-200 rounded p-2">
                                                    <p class="text-xs font-semibold text-yellow-800">
                                                        <i class="fas fa-comment mr-1"></i>Observaciones:
                                                    </p>
                                                    <p class="text-xs text-yellow-700 mt-1">${informeFinal.observaciones}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end">
                            <button onclick="closeModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            render();
        }

        // Función para evaluar un avance individual
async function evaluateAdvance(avanceId, newStatus) {
    // Solicitar observaciones solo si no es aprobado
    let observaciones = null;
    if (newStatus !== 'aprobado') {
        observaciones = prompt('Ingrese observaciones (opcional):');
        // Cancelar si el usuario presiona cancelar
        if (observaciones === null) {
            return;
        }
    }
    
    try {
        console.log('Evaluando avance:', avanceId, 'con estado:', newStatus);
        
        // Primero obtener el project_id del avance
        const { data: avanceData, error: fetchError } = await supabase
            .from('avances')
            .select('project_id')
            .eq('id', avanceId)
            .single();
        
        if (fetchError) {
            console.error('Error al obtener avance:', fetchError);
            throw fetchError;
        }
        
        const projectId = avanceData.project_id;
        
        // Preparar datos de actualización
        const updateData = {
            status: newStatus,
            evaluado_por: state.currentUser.id,
            fecha_evaluacion: new Date().toISOString()
        };
        
        // Solo agregar observaciones si hay texto
        if (observaciones && observaciones.trim() !== '') {
            updateData.observaciones = observaciones.trim();
        }
        
        console.log('Datos a actualizar:', updateData);
        
        // Actualizar el avance
        const { data, error } = await supabase
            .from('avances')
            .update(updateData)
            .eq('id', avanceId)
            .select()
            .single();

        if (error) {
            console.error('Error al actualizar avance:', error);
            throw error;
        }

        console.log('Avance actualizado exitosamente:', data);
        
        // Mostrar notificación según el estado
        const mensajes = {
            'aprobado': 'Avance aprobado exitosamente',
            'rechazado': 'Avance rechazado',
            'observado': 'Avance observado',
            'pendiente': 'Avance marcado como pendiente'
        };
        
        showNotification(mensajes[newStatus] || 'Avance actualizado', 'success');
        
        // Cerrar modal y recargar
        closeModal();
        setTimeout(() => {
            viewProjectScheduleEvaluator(projectId);
        }, 300);
        
    } catch (error) {
        console.error('Error completo al evaluar avance:', error);
        
        // Mensaje de error más específico
        let errorMsg = 'Error al evaluar el avance';
        if (error.message) {
            errorMsg += ': ' + error.message;
        }
        if (error.hint) {
            errorMsg += ' (' + error.hint + ')';
        }
        
        showNotification(errorMsg, 'error');
    }
}

        function viewProjectDetail(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;

            state.showModal = true;
            state.modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4" onclick="closeModal(event)">
                    <div class="bg-white rounded-lg w-full max-w-4xl" onclick="event.stopPropagation()">
                        <div class="bg-blue-600 text-white p-6 rounded-t-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-2xl font-bold mb-2">${project.title}</h3>
                                    <p class="text-blue-100">
                                        <i class="fas fa-user mr-2"></i>${project.users?.name || 'Sin asignar'}
                                    </p>
                                </div>
                                <button onclick="closeModal()" class="text-white hover:text-gray-200">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="p-6 max-h-[70vh] overflow-y-auto">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>Información General
            </h4>
            <div class="space-y-2 text-sm">
                <p><strong>Descripción:</strong> ${project.description || 'N/A'}</p>
                <p><strong>Tipo:</strong> ${
                    project.type === 'investigacion_aplicada' ? 'Investigación Aplicada' :
                    project.type === 'innovacion_tecnologica' ? 'Innovación Tecnológica' :
                    'Innovación Pedagógica'
                }</p>
                <p><strong>Estado:</strong> 
                    <span class="px-2 py-1 rounded-full text-xs font-semibold
                        ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                          project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                          project.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-gray-100 text-gray-800'}">
                        ${project.status || 'pendiente'}
                    </span>
                </p>
            </div>
        </div>

        <div>
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-users text-blue-600 mr-2"></i>Integrantes del Equipo
            </h4>
            <div class="bg-gray-50 rounded-lg p-3 space-y-2 text-sm max-h-48 overflow-y-auto">
                ${(() => {
                    try {
                        console.log('Integrantes raw:', project.integrantes);
                        
                        if (!project.integrantes) {
                            return '<p class="text-gray-500 italic text-center py-2"><i class="fas fa-user-slash mr-2"></i>Sin integrantes registrados</p>';
                        }
                        
                        let integrantes = [];
                        
                        // Intentar parsear si es string
                        if (typeof project.integrantes === 'string') {
                            integrantes = JSON.parse(project.integrantes);
                        } else if (Array.isArray(project.integrantes)) {
                            integrantes = project.integrantes;
                        }
                        
                        console.log('Integrantes parseados:', integrantes);
                        
                        if (!Array.isArray(integrantes) || integrantes.length === 0) {
                            return '<p class="text-gray-500 italic text-center py-2"><i class="fas fa-user-slash mr-2"></i>Sin integrantes registrados</p>';
                        }
                        
                        return integrantes.map((integrante, index) => {
                            if (!integrante || integrante.trim() === '') return '';
                            return `
                                <div class="flex items-center bg-white rounded p-2 shadow-sm">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 font-bold text-xs mr-2">
                                        ${index + 1}
                                    </div>
                                    <span class="flex-1">${integrante}</span>
                                    <i class="fas fa-user-check text-green-500"></i>
                                </div>
                            `;
                        }).filter(html => html !== '').join('');
                        
                    } catch (e) {
                        console.error('Error al mostrar integrantes:', e);
                        return '<p class="text-red-500 italic text-center py-2"><i class="fas fa-exclamation-triangle mr-2"></i>Error al cargar integrantes</p>';
                    }
                })()}
            </div>
        </div>

        <div>
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>Ubicación y Ejecución
            </h4>
            <div class="space-y-2 text-sm">
                <p><strong>Línea de Investigación:</strong> ${project.linea_investigacion || 'N/A'}</p>
                <p><strong>Lugar de Ejecución:</strong> ${project.lugar_ejecucion || 'N/A'}</p>
                <p><strong>Beneficiarios:</strong> ${project.beneficiarios || 'N/A'}</p>
            </div>
        </div>

        <div>
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>Cronología
            </h4>
            <div class="space-y-2 text-sm">
                <p><strong>Fecha de Inicio:</strong> ${project.fecha_inicio ? new Date(project.fecha_inicio).toLocaleDateString('es-ES') : 'N/A'}</p>
                <p><strong>Fecha de Fin:</strong> ${project.fecha_fin ? new Date(project.fecha_fin).toLocaleDateString('es-ES') : 'N/A'}</p>
                <p><strong>Creado:</strong> ${project.created_at ? new Date(project.created_at).toLocaleDateString('es-ES') : 'N/A'}</p>
            </div>
        </div>

        <div>
            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fas fa-dollar-sign text-blue-600 mr-2"></i>Presupuesto
            </h4>
            <div class="space-y-2 text-sm">
                <p><strong>Costos Estimados:</strong> S/ ${project.costos ? parseFloat(project.costos).toFixed(2) : '0.00'}</p>
            </div>
        </div>

        ${project.observaciones ? `
            <div class="md:col-span-2">
                <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                    <i class="fas fa-comment-alt text-yellow-600 mr-2"></i>Observaciones
                </h4>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm">
                    ${project.observaciones}
                </div>
            </div>
        ` : ''}
    </div>
</div>

                        <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            render();
        }

        function editProject(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    // Verificar si el proyecto puede ser editado
    if (project.status === 'aprobado' || project.status === 'rechazado') {
        showNotification('No se pueden editar proyectos aprobados o rechazados', 'error');
        return;
    }

    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="closeModal(event)">
            <div class="bg-white rounded-lg p-6 w-full max-w-3xl m-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                        Editar Proyecto
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                ${project.status === 'observado' && project.observaciones ? `
                    <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-500 rounded p-4">
                        <p class="text-sm font-bold text-yellow-800 mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Observaciones del evaluador:
                        </p>
                        <p class="text-sm text-yellow-700">${project.observaciones}</p>
                    </div>
                ` : ''}
                
                <form id="editProjectForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Título del Proyecto</label>
                            <input 
                                type="text" 
                                id="editProjectTitle" 
                                value="${project.title || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <textarea 
                                id="editProjectDescription" 
                                rows="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >${project.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto</label>
                            <select 
                                id="editProjectType" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                                <option value="investigacion_aplicada" ${project.type === 'investigacion_aplicada' ? 'selected' : ''}>Investigación Aplicada</option>
                                <option value="innovacion_tecnologica" ${project.type === 'innovacion_tecnologica' ? 'selected' : ''}>Innovación Tecnológica</option>
                                <option value="innovacion_pedagogica" ${project.type === 'innovacion_pedagogica' ? 'selected' : ''}>Innovación Pedagógica</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Línea de Investigación</label>
                            <input 
                                type="text" 
                                id="editProjectLinea" 
                                value="${project.linea_investigacion || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lugar de Ejecución</label>
                            <input 
                                type="text" 
                                id="editProjectLugar" 
                                value="${project.lugar_ejecucion || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beneficiarios</label>
                            <input 
                                type="text" 
                                id="editProjectBeneficiarios" 
                                value="${project.beneficiarios || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Costos Estimados (S/)</label>
                            <input 
                                type="number" 
                                id="editProjectCostos" 
                                value="${project.costos || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                            <input 
                                type="date" 
                                id="editProjectFechaInicio" 
                                value="${project.fecha_inicio || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                            <input 
                                type="date" 
                                id="editProjectFechaFin" 
                                value="${project.fecha_fin || ''}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                required
                            >
                        </div>
                    </div>

                    <!-- Sección de Integrantes -->
                    <div class="border-t pt-4 mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">
                                <i class="fas fa-users mr-1"></i>Integrantes del Proyecto
                            </label>
                            <button type="button" onclick="addIntegranteFieldEdit()" class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Agregar Integrante
                            </button>
                        </div>
                        <div id="integrantesContainerEdit" class="space-y-2">
                            ${(() => {
                                let integrantesHTML = '';
                                let integrantes = [];
                                
                                try {
                                    integrantes = project.integrantes ? JSON.parse(project.integrantes) : [''];
                                } catch (e) {
                                    integrantes = [''];
                                }
                                
                                if (integrantes.length === 0) integrantes = [''];
                                
                                integrantes.forEach((integrante, index) => {
                                    integrantesHTML += `
                                        <div class="flex gap-2 integrante-row-edit">
                                            <input type="text" value="${integrante}" placeholder="Nombre completo del integrante" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 integrante-input-edit">
                                            <button type="button" onclick="removeIntegranteFieldEdit(this)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    `;
                                });
                                
                                return integrantesHTML;
                            })()}
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Agregue los nombres completos de todos los integrantes del equipo de investigación
                        </p>
                    </div>

                    ${project.status === 'observado' ? `
                        <div class="bg-blue-50 border border-blue-200 rounded p-3">
                            <p class="text-xs text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Nota:</strong> Al guardar los cambios, el proyecto volverá al estado "Pendiente" para una nueva evaluación.
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-3 pt-4">
                        <button 
                            type="button" 
                            onclick="closeModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                            <i class="fas fa-save mr-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    render();

    // Event listener del formulario
    setTimeout(() => {
        document.getElementById('editProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Recopilar integrantes
            const integrantesInputs = document.querySelectorAll('.integrante-input-edit');
            const integrantes = [];
            integrantesInputs.forEach(input => {
                if (input.value.trim()) {
                    integrantes.push(input.value.trim());
                }
            });
            
            const updatedData = {
                title: document.getElementById('editProjectTitle').value,
                description: document.getElementById('editProjectDescription').value,
                type: document.getElementById('editProjectType').value,
                linea_investigacion: document.getElementById('editProjectLinea').value,
                lugar_ejecucion: document.getElementById('editProjectLugar').value,
                beneficiarios: document.getElementById('editProjectBeneficiarios').value,
                costos: parseFloat(document.getElementById('editProjectCostos').value),
                fecha_inicio: document.getElementById('editProjectFechaInicio').value,
                fecha_fin: document.getElementById('editProjectFechaFin').value,
                integrantes: JSON.stringify(integrantes),
                updated_at: new Date().toISOString()
            };

            // Si el proyecto estaba observado, cambiar a pendiente
            if (project.status === 'observado') {
                updatedData.status = 'pendiente';
                updatedData.observaciones = null;
            }

            try {
                const { data, error } = await supabase
                    .from('projects')
                    .update(updatedData)
                    .eq('id', projectId)
                    .select()
                    .single();

                if (error) throw error;

                showNotification('Proyecto actualizado exitosamente', 'success');
                state.projects = await getProjects();
                closeModal();
            } catch (error) {
                console.error('Error al actualizar proyecto:', error);
                showNotification('Error al actualizar proyecto: ' + error.message, 'error');
            }
        });
    }, 100);
}
// Función para agregar campo de integrante en edición
function addIntegranteFieldEdit() {
    const container = document.getElementById('integrantesContainerEdit');
    const newRow = document.createElement('div');
    newRow.className = 'flex gap-2 integrante-row-edit';
    newRow.innerHTML = `
        <input type="text" placeholder="Nombre completo del integrante" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 integrante-input-edit">
        <button type="button" onclick="removeIntegranteFieldEdit(this)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(newRow);
}

// Función para eliminar campo de integrante en edición
function removeIntegranteFieldEdit(button) {
    const container = document.getElementById('integrantesContainerEdit');
    const rows = container.querySelectorAll('.integrante-row-edit');
    
    // No permitir eliminar si solo hay un campo
    if (rows.length > 1) {
        button.parentElement.remove();
    } else {
        showNotification('Debe haber al menos un integrante', 'error');
    }
}

        function editUser(userId) {
    const user = state.users.find(u => u.id === userId);
    if (!user) return;

    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
            <div class="bg-white rounded-lg p-6 w-full max-w-md" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-user-edit text-blue-600 mr-2"></i>
                        Editar Usuario
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                        <input 
                            type="text" 
                            id="editUserName" 
                            value="${user.name}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="editUserEmail" 
                            value="${user.email}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                        <select 
                            id="editUserRole"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            required
                        >
                            <option value="docente" ${user.role === 'docente' ? 'selected' : ''}>Docente</option>
                            <option value="jefe_investigacion" ${user.role === 'jefe_investigacion' ? 'selected' : ''}>Jefe de Investigación</option>
                            <option value="direccion" ${user.role === 'direccion' ? 'selected' : ''}>Dirección General</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                        </select>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                        <p class="text-xs text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Nota:</strong> La contraseña no se puede cambiar desde aquí. Para cambiar la contraseña, contacte al administrador del sistema.
                        </p>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button 
                            type="button" 
                            onclick="closeModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                            <i class="fas fa-save mr-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    render();

    // Event listener del formulario
    setTimeout(() => {
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const updatedData = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                role: document.getElementById('editUserRole').value
            };

            try {
                const { data, error } = await supabase
                    .from('users')
                    .update(updatedData)
                    .eq('id', userId)
                    .select()
                    .single();

                if (error) throw error;

                showNotification('Usuario actualizado exitosamente', 'success');
                state.users = await getUsers();
                closeModal();
            } catch (error) {
                console.error('Error al actualizar usuario:', error);
                showNotification('Error al actualizar usuario: ' + error.message, 'error');
            }
        });
    }, 100);
}
        // ============================================
// FUNCIONES DE FILTRADO
// ============================================

// Filtrar usuarios
function filterUsers() {
    const searchInput = document.getElementById('userSearchInput');
    const roleFilter = document.getElementById('userRoleFilter');
    const rows = document.querySelectorAll('.user-row');
    const countSpan = document.getElementById('userFilterCount');
    
    if (!searchInput || !roleFilter) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const selectedRole = roleFilter.value;
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const email = row.getAttribute('data-email') || '';
        const role = row.getAttribute('data-role') || '';
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesRole = !selectedRole || role === selectedRole;
        
        if (matchesSearch && matchesRole) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    if (countSpan) {
        countSpan.textContent = `Mostrando ${visibleCount} de ${rows.length} usuarios`;
    }
}

// Limpiar filtros de usuarios
function clearUserFilters() {
    const searchInput = document.getElementById('userSearchInput');
    const roleFilter = document.getElementById('userRoleFilter');
    
    if (searchInput) searchInput.value = '';
    if (roleFilter) roleFilter.value = '';
    
    filterUsers();
}

// Estado actual del filtro de tipo
let currentTypeFilter = '';

// Filtrar proyectos
function filterProjects() {
    const searchInput = document.getElementById('projectSearchInput');
    const statusFilter = document.getElementById('projectStatusFilter');
    const rows = document.querySelectorAll('.project-row');
    const countSpan = document.getElementById('projectFilterCount');
    
    if (!searchInput || !statusFilter) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const selectedStatus = statusFilter.value;
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const title = row.getAttribute('data-title') || '';
        const description = row.getAttribute('data-description') || '';
        const status = row.getAttribute('data-status') || '';
        const type = row.getAttribute('data-type') || '';
        
        const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        const matchesStatus = !selectedStatus || status === selectedStatus;
        const matchesType = !currentTypeFilter || type === currentTypeFilter;
        
        if (matchesSearch && matchesStatus && matchesType) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    if (countSpan) {
        countSpan.textContent = `Mostrando ${visibleCount} de ${rows.length} proyectos`;
    }
}

// Filtrar proyectos por tipo
function filterProjectsByType(type) {
    currentTypeFilter = type;
    
    // Actualizar estilos de botones
    const buttons = document.querySelectorAll('[id^="typeFilter_"]');
    buttons.forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'font-semibold');
        btn.classList.add('border-gray-300');
    });
    
    const activeButton = document.getElementById(`typeFilter_${type || 'all'}`);
    if (activeButton) {
        activeButton.classList.remove('border-gray-300');
        activeButton.classList.add('border-blue-500', 'bg-blue-50', 'font-semibold');
    }
    
    filterProjects();
}

// Limpiar filtros de proyectos
function clearProjectFilters() {
    const searchInput = document.getElementById('projectSearchInput');
    const statusFilter = document.getElementById('projectStatusFilter');
    
    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = '';
    
    currentTypeFilter = '';
    filterProjectsByType('');
}
// Función para mostrar el cronograma de un proyecto específico
async function viewProjectSchedule(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    // Validar que el proyecto tenga fechas
    if (!project.fecha_inicio || !project.fecha_fin) {
        showNotification('El proyecto no tiene fechas de inicio y fin definidas', 'error');
        return;
    }

    // Generar cronograma basado en las fechas del proyecto
    const cronogramaProyecto = generarCronograma(project.fecha_inicio, project.fecha_fin);
    
    // Verificar si todos los avances están aprobados
    const avancesAprobados = await verificarAvancesAprobados(projectId);
    const evaluacionFinal = await verificarEvaluacionFinal(projectId); 
    
    // Verificar si existe informe final
    const { data: informeFinalData } = await supabase
        .from('avances')
        .select('*')
        .eq('project_id', projectId)
        .eq('numero_avance', 7)
        .single();

    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" onclick="closeModal(event)">
            <div class="bg-white rounded-lg w-full max-w-5xl my-8" onclick="event.stopPropagation()">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">
                                <i class="fas fa-calendar-check mr-2"></i>
                                Cronograma del Proyecto
                            </h3>
                            <p class="text-blue-100">${project.title}</p>
                        </div>
                        <button onclick="closeModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Información del proyecto -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Tipo:</span>
                                <span class="font-semibold ml-2">${
                                    project.type === 'investigacion_aplicada' ? 'Investigación Aplicada' :
                                    project.type === 'innovacion_tecnologica' ? 'Innovación Tecnológica' :
                                    'Innovación Pedagógica'
                                }</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Estado:</span>
                                <span class="ml-2 px-2 py-1 rounded-full text-xs font-semibold
                                    ${project.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                      project.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                      project.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${project.status || 'pendiente'}
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-600">Período:</span>
                                <span class="font-semibold ml-2">
                                    ${project.fecha_inicio ? new Date(project.fecha_inicio).toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }) : 'N/A'} - 
                                    ${project.fecha_fin ? new Date(project.fecha_fin).toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }) : 'N/A'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Avances del cronograma (1-6) -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-tasks text-blue-600 mr-2"></i>
                            Avances del Proyecto (6 entregas)
                        </h4>
                        <div class="space-y-4" id="scheduleContainer">
                            ${cronogramaProyecto.map((item, index) => {
                                const fechaLimite = new Date(item.fecha);
                                const hoy = new Date();
                                const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
                                const vencido = diasRestantes < 0;
                                const proximo = !vencido && diasRestantes <= 7;
                                
                                return `
                                    <div class="border-2 ${
                                        vencido ? 'border-red-300 bg-red-50' : 
                                        proximo ? 'border-yellow-300 bg-yellow-50' : 
                                        'border-gray-200 bg-white'
                                    } rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between">
                                            <!-- Información del avance -->
                                            <div class="flex items-center gap-4 flex-1">
                                                <div class="flex items-center justify-center w-12 h-12 rounded-full ${
                                                    vencido ? 'bg-red-200 text-red-700' : 
                                                    proximo ? 'bg-yellow-200 text-yellow-700' : 
                                                    'bg-blue-200 text-blue-700'
                                                } font-bold text-lg">
                                                    ${index + 1}
                                                </div>
                                                
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-gray-800 mb-1">${item.entrega}</h4>
                                                    <div class="flex items-center gap-3 text-sm">
                                                        <span class="${vencido ? 'text-red-600' : proximo ? 'text-yellow-600' : 'text-gray-600'}">
                                                            <i class="fas fa-calendar mr-1"></i>
                                                            ${fechaLimite.toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' })}
                                                        </span>
                                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                            vencido ? 'bg-red-100 text-red-700' : 
                                                            proximo ? 'bg-yellow-100 text-yellow-700' : 
                                                            'bg-blue-100 text-blue-700'
                                                        }">
                                                            ${vencido ? `Vencido hace ${Math.abs(diasRestantes)} días` : 
                                                              proximo ? `Faltan ${diasRestantes} días` : 
                                                              `Faltan ${diasRestantes} días`}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acciones -->
                                            <div class="flex items-center gap-2">
                                                <div id="status_${project.id}_${index + 1}" class="mr-2">
                                                    <!-- Se llenará con el estado del avance -->
                                                </div>
                                                <button 
                                                    onclick="uploadAdvance('${project.id}', ${index + 1}, '${item.entrega}')"
                                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 transition-colors"
                                                >
                                                    <i class="fas fa-upload"></i>
                                                    <span>Subir</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Separador -->
                    <div class="border-t-2 border-gray-200 my-6"></div>

                    <!-- Informe Final (Apartado separado) -->
                    <div class="mb-4">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-file-alt text-purple-600 mr-2"></i>
                            Informe Final del Proyecto
                        </h4>
                        
                        ${!avancesAprobados ? `
    <div class="bg-gray-100 border-2 border-gray-300 rounded-lg p-6 text-center">
        <i class="fas fa-lock text-gray-400 text-4xl mb-3"></i>
        <h5 class="font-bold text-gray-700 mb-2">Informe Final Bloqueado</h5>
        <p class="text-sm text-gray-600 mb-3">
            Para habilitar la entrega del informe final, todos los 6 avances deben estar aprobados por el Jefe de Investigación.
        </p>
    </div>
` : !evaluacionFinal ? `
    <div class="bg-blue-100 border-2 border-blue-300 rounded-lg p-6 text-center">
        <i class="fas fa-hourglass-half text-blue-500 text-4xl mb-3"></i>
        <h5 class="font-bold text-blue-700 mb-2">Esperando Evaluación Final</h5>
        <p class="text-sm text-blue-700 mb-3">
            Todos los avances están aprobados. El Jefe de Investigación debe realizar la evaluación pre-informe final.
        </p>
    </div>
` : !evaluacionFinal.aprobado ? `
    <div class="bg-red-100 border-2 border-red-300 rounded-lg p-6 text-center">
        <i class="fas fa-times-circle text-red-500 text-4xl mb-3"></i>
        <h5 class="font-bold text-red-700 mb-2">Evaluación No Aprobada</h5>
        <p class="text-sm text-red-700 mb-3">
            La evaluación pre-informe obtuvo ${evaluacionFinal.porcentaje}% (se requiere mínimo 70%).
        </p>
        ${evaluacionFinal.observaciones ? `
            <div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-left text-red-800 mb-3">
                <p class="font-semibold mb-1"><i class="fas fa-comment-alt mr-1"></i>Observaciones del evaluador:</p>
                <p>${evaluacionFinal.observaciones}</p>
            </div>
        ` : ''}
        ${evaluacionFinal.pdf_url ? `
            <a href="${evaluacionFinal.pdf_url}" target="_blank" class="inline-block bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-file-pdf mr-2"></i>Ver Evaluación Completa (PDF)
            </a>
        ` : ''}
    </div>
` : `
    <div class="border-2 border-green-300 bg-green-50 rounded-lg p-4">
        ${evaluacionFinal.pdf_url ? `
            <div class="bg-green-100 border border-green-200 rounded p-3 mb-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            Evaluación Pre-Informe Aprobada (${evaluacionFinal.porcentaje}%)
                        </p>
                        <p class="text-xs text-green-700 mt-1">Ya puede proceder con la entrega del informe final</p>
                    </div>
                    <a href="${evaluacionFinal.pdf_url}" target="_blank" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm">
                        <i class="fas fa-file-pdf mr-1"></i>Ver Evaluación
                    </a>
                </div>
            </div>
        ` : ''}
                            <!-- Habilitado: Puede subir informe -->
                            <div class="border-2 border-green-300 bg-green-50 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4 flex-1">
                                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-green-200 text-green-700 font-bold text-lg">
                                            <i class="fas fa-flag-checkered"></i>
                                        </div>
                                        
                                        <div class="flex-1">
                                            <h4 class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                                                Informe Final
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                                    <i class="fas fa-check-circle mr-1"></i>
                                                    Habilitado
                                                </span>
                                            </h4>
                                            <div class="flex items-center gap-3 text-sm text-gray-600">
                                                <span>
                                                    <i class="fas fa-calendar mr-1"></i>
                                                    Fecha límite: ${new Date(project.fecha_fin).toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' })}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div id="status_${project.id}_7" class="mr-2">
                                            ${informeFinalData ? `
                                                <div class="flex items-center gap-2">
                                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                                        informeFinalData.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                                        informeFinalData.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                                        informeFinalData.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-blue-100 text-blue-800'
                                                    }">
                                                        <i class="fas ${
                                                            informeFinalData.status === 'aprobado' ? 'fa-check-circle' :
                                                            informeFinalData.status === 'rechazado' ? 'fa-times-circle' :
                                                            informeFinalData.status === 'observado' ? 'fa-exclamation-circle' :
                                                            'fa-clock'
                                                        } mr-1"></i>
                                                        ${informeFinalData.status === 'aprobado' ? 'Aprobado' :
                                                          informeFinalData.status === 'rechazado' ? 'Rechazado' :
                                                          informeFinalData.status === 'observado' ? 'Observado' :
                                                          'En revisión'}
                                                    </span>
                                                    ${informeFinalData.archivo_url ? `
                                                        <a href="${informeFinalData.archivo_url}" target="_blank" class="text-blue-600 hover:text-blue-800" title="Ver archivo">
                                                            <i class="fas fa-file-download"></i>
                                                        </a>
                                                    ` : ''}
                                                </div>
                                            ` : `
                                                <span class="text-gray-400 text-sm">
                                                    <i class="fas fa-circle text-xs mr-1"></i>
                                                    Pendiente
                                                </span>
                                            `}
                                        </div>
                                        <button 
                                            onclick="uploadAdvance('${project.id}', 7, 'Informe Final')"
                                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 transition-colors"
                                        >
                                            <i class="fas fa-upload"></i>
                                            <span>Subir Informe</span>
                                        </button>
                                    </div>
                                </div>
                                
                                ${informeFinalData?.observaciones ? `
                                    <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded p-3">
                                        <p class="text-xs font-semibold text-yellow-800 mb-1">
                                            <i class="fas fa-comment-alt mr-1"></i>Observaciones del evaluador:
                                        </p>
                                        <p class="text-sm text-yellow-700">${informeFinalData.observaciones}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `}
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-b-lg flex justify-end">
                    <button onclick="closeModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
    render();

    // Después de renderizar, cargar el estado de los avances
    setTimeout(async () => {
        await loadAdvancesStatus(projectId);
    }, 100);
}

// Función para cargar el estado de los avances de un proyecto
async function loadAdvancesStatus(projectId) {
    try {
        const project = state.projects.find(p => p.id === projectId);
        if (!project || !project.fecha_inicio || !project.fecha_fin) return;
        
        const cronogramaProyecto = generarCronograma(project.fecha_inicio, project.fecha_fin);
        
        const { data, error } = await supabase
            .from('avances')
            .select('*')
            .eq('project_id', projectId);

        if (error) throw error;

        // Actualizar el estado de cada avance en el DOM
        cronogramaProyecto.forEach((item, index) => {
            const avanceNum = index + 1;
            const statusDiv = document.getElementById(`status_${projectId}_${avanceNum}`);
            
            if (statusDiv) {
                const avance = data.find(a => a.numero_avance === avanceNum);
                
                if (avance) {
                    statusDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                avance.status === 'aprobado' ? 'bg-green-100 text-green-800' :
                                avance.status === 'rechazado' ? 'bg-red-100 text-red-800' :
                                avance.status === 'observado' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-blue-100 text-blue-800'
                            }">
                                <i class="fas ${
                                    avance.status === 'aprobado' ? 'fa-check-circle' :
                                    avance.status === 'rechazado' ? 'fa-times-circle' :
                                    avance.status === 'observado' ? 'fa-exclamation-circle' :
                                    'fa-clock'
                                } mr-1"></i>
                                ${avance.status === 'aprobado' ? 'Aprobado' :
                                  avance.status === 'rechazado' ? 'Rechazado' :
                                  avance.status === 'observado' ? 'Observado' :
                                  'Entregado'}
                            </span>
                            ${avance.archivo_url ? `
                                <a href="${avance.archivo_url}" target="_blank" class="text-blue-600 hover:text-blue-800" title="Ver archivo">
                                    <i class="fas fa-file-download"></i>
                                </a>
                            ` : ''}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <span class="text-gray-400 text-sm">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            Pendiente
                        </span>
                    `;
                }
            }
        });
    } catch (error) {
        console.error('Error al cargar estado de avances:', error);
    }
}
        // Reemplaza la función uploadAdvance (aproximadamente línea 1800)
function uploadAdvance(projectId, numeroAvance, tituloAvance) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    state.showModal = true;
    state.modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeModal(event)">
            <div class="bg-white rounded-lg w-full max-w-md" onclick="event.stopPropagation()">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold">Subir Avance</h3>
                            <p class="text-sm text-blue-100">${tituloAvance}</p>
                        </div>
                        <button onclick="closeModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6">
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>Proyecto:</strong> ${project.title}
                        </p>
                        <p class="text-sm text-gray-600">
                            <strong>Avance:</strong> ${numeroAvance} - ${tituloAvance}
                        </p>
                    </div>

                    <form id="uploadAdvanceForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file-upload mr-1"></i>
                                Seleccionar archivo
                            </label>
                            <input 
                                type="file" 
                                id="avanceFile" 
                                accept=".pdf,.doc,.docx,.zip"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            >
                            <p class="text-xs text-gray-500 mt-1">Formatos permitidos: PDF, DOC, DOCX, ZIP</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Observaciones (opcional)
                            </label>
                            <textarea 
                                id="avanceObservaciones"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="Comentarios adicionales sobre este avance..."
                            ></textarea>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button 
                                type="button" 
                                onclick="closeModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                <i class="fas fa-upload mr-2"></i>Subir Avance
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    render();

    // Event listener del formulario
    setTimeout(() => {
        document.getElementById('uploadAdvanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = document.getElementById('avanceFile').files[0];
            const observaciones = document.getElementById('avanceObservaciones').value;

            if (!file) {
                showNotification('Selecciona un archivo', 'error');
                return;
            }

            showNotification('Subiendo archivo...', 'info');

            // Subir archivo a Supabase Storage
            const fileUrl = await uploadFile(file, projectId, `avance_${numeroAvance}`);

            if (fileUrl) {
                // Guardar el avance en la base de datos
                const { data, error } = await supabase
                    .from('avances')
                    .insert([{
                        project_id: projectId,
                        numero_avance: numeroAvance,
                        titulo_avance: tituloAvance,
                        archivo_url: fileUrl,
                        archivo_nombre: file.name,
                        observaciones: observaciones,
                        status: 'pendiente'
                    }])
                    .select()
                    .single();

                if (error) {
                    console.error('Error al guardar avance:', error);
                    showNotification('Error al guardar el avance: ' + error.message, 'error');
                } else {
                    showNotification('Avance subido exitosamente', 'success');
                    closeModal();
                    // Abrir de nuevo el cronograma actualizado
                    setTimeout(() => {
                        viewProjectSchedule(projectId);
                    }, 500);
                }
            } else {
                showNotification('Error al subir el archivo', 'error');
            }
        });
    }, 100);
}

        function downloadProject(projectId) {
            showNotification('Descargando proyecto...', 'info');
        }

        function confirmDeleteProject(projectId) {
            if (confirm('¿Estás seguro de eliminar este proyecto?')) {
                showNotification('Función de eliminación en desarrollo', 'info');
            }
        }

        function viewProject(projectId) {
            viewProjectDetail(projectId);
        }

        // ============================================
        // FUNCIÓN PRINCIPAL DE RENDER
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            let content = '';

            if (state.view === 'login') {
                content = renderLogin();
            } else if (state.currentUser) {
                if (state.currentUser.role === 'admin') {
                    if (state.view === 'admin-dashboard' || state.view === 'admin-users' || 
                        state.view === 'admin-projects' || state.view === 'admin-settings') {
                        content = renderAdminDashboard();
                    }
                } else if (state.currentUser.role === 'docente') {
                    content = renderDocenteDashboard();
                } else if (state.currentUser.role === 'jefe_investigacion') {
                    content = renderJefeDashboard();
                } else if (state.currentUser.role === 'direccion') {
                    content = renderDireccionDashboard();
                }
            }

            // Agregar notificaciones y modal si existen
            content += renderNotifications();
            if (state.showModal && state.modalContent) {
                content += state.modalContent;
            }

            app.innerHTML = content;

            // Event listener para el formulario de login
            if (state.view === 'login') {
                setTimeout(() => {
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const email = document.getElementById('loginEmail').value;
                            const password = document.getElementById('loginPassword').value;

                            const user = await loginUser(email, password);
                            
                            if (user) {
                                state.currentUser = user;
                                showNotification(`Bienvenido ${user.name}`, 'success');
                                
                                // Cargar datos iniciales
                                if (user.role === 'admin') {
                                    state.users = await getUsers();
                                    state.view = 'admin-users';
                                } else if (user.role === 'docente') {
                                    state.view = 'docente-dashboard';
                                } else if (user.role === 'jefe_investigacion') {
                                    state.view = 'jefe-dashboard';
                                } else if (user.role === 'direccion') {
                                    state.view = 'direccion-dashboard';
                                }

                                state.projects = await getProjects();
                                render();
                            } else {
                                showNotification('Credenciales incorrectas', 'error');
                            }
                        });
                    }
                }, 100);
            }
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        async function init() {
            // Verificar si hay una sesión activa
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                // Obtener datos del usuario
                const { data: userData } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', session.user.email)
                    .single();

                if (userData) {
                    state.currentUser = userData;
                    
                    if (userData.role === 'admin') {
                        state.users = await getUsers();
                        state.view = 'admin-users';
                    } else if (userData.role === 'docente') {
                        state.view = 'docente-dashboard';
                    } else if (userData.role === 'jefe_investigacion') {
                        state.view = 'jefe-dashboard';
                    } else if (userData.role === 'direccion') {
                        state.view = 'direccion-dashboard';
                    }

                    state.projects = await getProjects();
                }
            }

            render();
        }

        // Iniciar la aplicación
        init();
    </script>

    <style>
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Estilos para inputs */
        input:focus, select:focus, textarea:focus {
            outline: none;
        }

        /* Transiciones suaves */
        button {
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
        }
    </style>
</body>
</html>